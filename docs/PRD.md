# Goyais PRD（最小可发布版）

- 版本：v0.1-draft
- 更新日期：2026-02-25
- 状态：Draft（待产品/技术联合评审）
- 负责人：PM + Arch

## 1. 背景与目标

Goyais 提供 Desktop + Hub 的协同执行能力，目标是让开发者在本地或远程工作区中完成“对话驱动的代码变更、执行与回放”。

本阶段目标：
1. 建立可用于 RC 的安全与正确性基线。
2. 在多工作区场景下保证鉴权边界与数据隔离。
3. 形成可复现的工程质量门禁（test/lint/coverage）。

## 2. 范围

### 2.1 In Scope

1. 会话链路：创建会话、提交消息、领取执行、回传事件、前端状态合并。
2. 控制链路：停止、回滚、提交、丢弃。
3. 多租户与权限：workspace 级鉴权、管理接口授权边界、内部 token 管理。
4. 工程门禁：Hub/Desktop 的测试与 lint；Desktop coverage gate。

### 2.2 Out of Scope

1. 外部系统渗透测试。
2. 生产级压测实施（仅产出计划，不落地压测执行）。
3. 新功能开发与 UI 大规模重构。

## 3. 核心用户故事

1. 作为开发者，我希望在会话中提交需求后，系统能可靠地产生 execution 并回传事件，避免状态漂移。
2. 作为团队管理员，我希望不同 workspace 的资源与策略不能被跨租户越权访问。
3. 作为发布负责人，我希望本地与 CI 的质量门禁一致且可复现。

## 4. 非功能需求（NFR）

1. 安全性：所有控制面接口默认认证；内部接口禁止弱默认凭证。
2. 一致性：SSE 断线重连后支持 resync，避免静默丢事件。
3. 可观测性：关键失败路径具备可定位日志（鉴权失败、内部 token 缺失、门禁失败）。
4. 工程性：主干必须通过 test/lint；发布前必须通过 coverage gate。

## 5. 验收标准

### 5.1 功能与正确性

1. 远程 workspace SSE 连接可稳定收事件。
2. execution patch 仅包含本 execution 关联变更。
3. `last_event_id` 失效场景下客户端可触发全量重同步并恢复一致。

### 5.2 安全与隔离

1. 未认证请求访问管理接口返回 401/403。
2. 跨 workspace 越权请求返回 403。
3. 内部接口在未配置 token 时（非不安全模式）拒绝服务。

### 5.3 工程门禁

1. `services/hub`: `go test ./...` + `go vet ./...` 通过。
2. `apps/desktop`: `pnpm lint` + `pnpm test` + `pnpm coverage:gate` 通过。

## 6. 里程碑

1. M1（已完成）：P0/P1 安全与核心正确性问题关闭。
2. M2（进行中）：Desktop coverage gate 达标并稳定复现。
3. M3（待开始）：Release checklist 与回滚手册固化。

## 7. 风险与依赖

1. 覆盖率门禁未达标会阻塞正式发布。
2. 若后续接口演进缺少兼容策略，可能影响 Desktop/Hub 协同。
3. 依赖项（Node/Go）版本漂移可能导致本地与 CI 行为差异。

## 8. 发布 Go/No-Go

### Go

1. P0/P1 全部关闭且有回归测试。
2. 三层 test/lint 全通过。
3. Desktop coverage gate 通过。

### No-Go

1. 覆盖率门禁未达标。
2. 出现未关闭 P0/P1。
3. 鉴权或跨租户隔离回归失败。
