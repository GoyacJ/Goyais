# Goyais PRD（产品需求文档）v0.2.0
角色：产品负责人（Product Owner）
协议：Apache-2.0
定位：对话式 AI 编程辅助工具（桌面端为主），支持本地单机完整能力 + 远程团队协作（Remote Hub）。
核心原则：**不引入额外概念**。产品仅围绕 **工作区 → 项目 → 会话**，会话内以主流工具方式展示“思考/工具调用/差异/确认/结果”。

---

## 1. 背景与问题陈述

### 1.1 背景
开发者使用 AI 辅助编程时的关键痛点：
- 工具执行边界不清：写文件/执行命令/联网等风险高，缺乏强制确认与审计
- 团队协作缺失：权限、菜单、数据隔离不一致；共享对话与历史难
- 并行开发冲突：多人/多任务同时修改同一项目容易互相污染
- 可诊断性不足：执行过程不可回放，问题难以复现与定位

### 1.2 目标
构建一个符合主流体验（Claude Code/Codex/Cursor）的 AI 编程工具：
- 以“**会话**”作为主要工作单位（对用户只暴露会话概念）
- 在会话中自然呈现：思考/计划 → 工具调用 → diff/结果 → 确认/审计
- 支持：本地单机完整使用 + 连接远程协作工作区（动态菜单与权限、共享数据源）

---

## 2. 产品范围（Scope）

### 2.1 In Scope（v0.2.0 必须具备）
1) **多工作区（Local + Remote）**
- Local：客户端下载即可用（本机执行、离线可用）
- Remote：连接 remote hub，获取该工作区定义的菜单、功能、权限、项目、会话、历史等

2) **对话式主界面（主流方式）**
- 左侧：工作区切换（顶部）+ 项目列表 + 会话列表（中部）+ 设置/账号/登出（底部）
- 中间：会话对话（消息与执行过程）
- 右侧：执行详情（Diff/工具调用详情/上下文/权限队列）
- 底部：状态条（Local/Remote、endpoint、health、诊断入口）

3) **工作区内：多个项目；项目内：多个会话**
- Project 是内容与执行的边界；会话是交互边界
- 会话可创建/切换/重命名/归档（按权限）

4) **会话执行方式（Claude Code/Codex/Cursor 方式）**
- 用户发送一条指令后，在同一会话内流式呈现：
  - 思考/计划（可折叠）
  - 工具调用（可折叠）
  - diff（重点展示）
  - 结果与错误（可复制诊断）
- **同一会话同一时间只能有一个执行在进行（硬约束）**
  - 会话忙时再次发送：提示“正在执行”，给出选项：
    - 取消当前执行并开始新指令
    - 新建会话执行
      -（可选）排队（需明确选择）

5) **plan / agent 两种会话模式**
- plan 模式：先给计划，用户确认计划后再执行工具
- agent 模式：允许直接执行与产出 diff，但敏感操作必须确认

6) **会话级配置**
- 独立模型选择（每会话选择 model profile）
- 独立选择 skills 与 MCP connectors（可启用集合）
- 默认是否使用 worktree（可配置）

7) **worktree 隔离（并行开发的正确方式）**
- 同一项目可开多个会话并行开发
- 每次执行可选创建 worktree（建议默认开启）
- worktree 作为执行目录隔离，避免并行污染

8) **安全默认：capability prompt + 审计**
- 写文件 / 执行命令 / 联网 / 外发等高风险操作必须确认
- confirm 权限独立（confirm:write），后端强制
- 审计：记录发起人、操作、参数摘要、结果、时间、归属项目/会话

9) **团队项目模型（Remote）：仅 Git repo（你已确认 A）**
- Remote 项目源为 Git repo URL
- 服务端 clone/sync 到 repo cache
- 会话执行在服务端 worker 侧进行
- 项目与会话在 workspace 内共享（按 RBAC/数据权限控制）

10) **Git 本地提交归属（团队模式关键）**
- 共享同一项目 + worktree 并行开发时：
  - 在服务端 worktree 内支持 **本地 commit（不 push）**
  - commit author/committer 必须为“当前客户端登录用户”
  - 同时提供 **导出 patch**（unified diff）
- 未来扩展 push/PR（不在 v0.2.0）

11) **国际化与主题**
- zh-CN / en-US
- dark/light 主题一致

### 2.2 Out of Scope（v0.2.0 不做）
- 自动 push、自动 PR
- conversation 级聚合回放/并发多执行交错展示（避免认知混乱）
- 多组织/复杂审批流
- 官方托管
- 实时协同编辑（CRDT/OT）

---

## 3. 目标用户与使用场景

### 3.1 用户画像
- 个人开发者：本地优先，强调效率与可控安全
- 团队/企业：远程协作，强调权限/审计/共享数据源/一致执行环境

### 3.2 典型用户流程

#### 场景 A：本地单机
1) 打开客户端，选择 local workspace
2) 添加项目（本地 repo）
3) 创建会话，选择 plan/agent、模型、skills/MCP
4) 输入指令 → 会话内展示思考/工具调用/diff/确认 → 完成
5) 会话历史自然呈现；可导出 patch/诊断

#### 场景 B：团队协作（Remote workspace）
1) 添加 remote hub，登录
2) 选择 remote workspace（菜单与权限自动变化）
3) 添加项目（Git repo URL）→ 服务端 clone/sync → ready
4) 创建会话（模式/模型/skills/MCP）
5) 输入指令 → 服务端 worker 执行 → 会话内流式展示执行过程
6) 需要确认时由具备 confirm 权限的角色审批
7) 在 worktree 内本地 commit（author=当前用户）或导出 patch

---

## 4. 信息架构与导航

### 4.1 主导航结构
- Workspace（local/remote）
  - Projects（列表）
    - Sessions（列表）
      - SessionPage（会话页：对话与执行过程）

### 4.2 Sidebar（左侧）
- 顶部：Workspace Switcher
- 中部：Project list（可展开 session list）
  - Add Project（权限控制）
  - Add Session（权限控制）
- 底部：Settings / Account / Logout（弹层）

### 4.3 Settings（设置）
- Account：remote 登录/登出、token 清理
- Workspace：当前 workspace 信息（endpoint、workspace_id）
- Preferences：语言、主题
- Models：模型配置管理与默认模型
- Skills/MCP：可启用集合管理（按权限）
- Diagnostics：health/version/复制诊断/导出诊断（脱敏）

---

## 5. 核心对象定义（产品视角）

### 5.1 Workspace
- kind：local | remote
- remote 绑定 hub endpoint + 登录态
- workspace 是权限与数据隔离边界

### 5.2 Project
- local：本地 repo 路径
- remote：Git repo URL + branch，服务端 repo cache
- 状态：syncing/ready/error

### 5.3 Session（会话）
- title
- mode：plan | agent
- model profile
- skills/MCP 启用集合
- 会话状态：idle / executing / waiting_confirmation（用于 UI 展示）

> v0.2.0 强约束：会话同时只允许一个执行进行中。

---

## 6. 功能需求（Functional Requirements）

### 6.1 工作区
- 新增/切换 workspace（local/remote）
- remote 登录/登出（登出清理 keychain token + 清理 remote 缓存）
- 切换后：菜单、项目、会话、模型配置立即跟随变化

### 6.2 动态菜单与权限（Remote）
- hub 下发菜单树与权限
- UI 仅显示可见项
- 后端强制所有权限校验（UI 仅做体验优化）

### 6.3 项目（Project）
#### Local
- 从本机目录添加 repo（或 init）
#### Remote（Git repo only）
- 新增项目：repo_url + branch +（可选）凭证引用
- 同步：clone/pull/fetch
- 状态可见：syncing/ready/error
- 共享：workspace 成员可见（P0）

### 6.4 会话（Session）
- 创建会话、重命名、归档
- 会话级配置：
  - plan/agent
  - model profile
  - skills/MCP 启用集合

### 6.5 会话执行（主流方式）
- 用户发送指令：
  - 会话进入 executing 状态
  - 会话内流式展示思考/工具调用/diff/结果
- 会话忙时再次发送：
  - 弹出提示：Cancel current / New session / Queue（如实现）
- 支持 cancel（取消当前执行）

### 6.6 worktree
- 每次执行可选使用 worktree（建议默认开启）
- worktree 基于“每次执行”生成独立目录
- 清理策略可配置（成功默认清理，失败保留）

### 6.7 Capability Prompt（确认）
- 敏感能力必须确认：
  - write_fs / exec / network / delete / exfil
- confirm 权限独立（confirm:write）
- Always allow scope：workspace + tool + risk；支持 reset

### 6.8 diff 与导出
- diff 展示（diff-first）
- 导出 patch（unified diff）
- apply patch 必须确认（按风险策略）

### 6.9 Git 本地 commit（团队模式）
- 在服务端 worktree 内执行本地 commit（不 push）
- commit author/committer = 当前登录用户（git_name/git_email）
- 权限：git:write
- 审计：git.commit（包含 commit_sha 等，不含密钥）
- 同时提供导出 patch

### 6.10 Skills/MCP
- workspace 级资源管理（管理员）
- 会话可启用集合
- 外部访问审计与风险控制

---

## 7. 安全与合规（NFR）

### 7.1 信任边界
- remote：客户端只连接 hub；执行在服务端 worker
- secrets 不出 hub；worker internal resolve 一次性使用
- 所有敏感操作服务端强制校验与审计

### 7.2 数据隔离
- workspace 为隔离边界
- 项目/会话/历史不可跨 workspace 读取

### 7.3 审计与诊断
- 关键动作审计：工具调用、确认决策、git.commit、项目同步
- 诊断导出脱敏：不包含 token/secret 明文

---

## 8. 可观测性与稳定性（NFR）
- trace_id 贯穿执行链路
- SSE 稳定、断线重连
- 并发上限与队列（保证系统可用）
- UI 无闪烁，执行状态明确可见

---

## 9. 验收标准（Acceptance Criteria）

### 9.1 本地
- 可创建项目/会话；会话内执行过程呈现符合主流工具（思考/工具/差异/确认/完成）
- 会话同一时间只有一个执行，状态明确
- worktree 隔离有效
- 导出 patch 与诊断可用
- 设置内语言/主题/模型配置生效

### 9.2 团队
- remote 登录/切换 workspace 后菜单/权限正确
- Git repo 项目可添加并同步 ready
- 会话共享与历史共享可用（按权限）
- confirm 权限生效（无 confirm:write 无法审批）
- 本地 commit：author/committer=当前用户，审计可查
- 多会话并行开发不互相污染（worktree 隔离）

---

## 10. 术语（为避免概念混淆）
- 工作区（Workspace）：隔离边界（local/remote）
- 项目（Project）：工作单元（remote 以 Git repo 为源）
- 会话（Session）：用户交互线程；v0.2.0 仅暴露会话概念
- “执行”：会话中发送指令触发的一次工具执行过程（对用户表现为思考/工具调用/差异/确认/结果）
