# Goyais v0.2.0 技术选型评审

角色：首席架构师
日期：2026-02-21
目标：评估当前技术栈是否适合 v0.2.0 架构需求，给出调整建议。

---

## 0. 当前技术矩阵

| 层 | 技术 | 版本 | 用途 |
|----|------|------|------|
| Desktop UI | React | 19.0.0 | 组件框架 |
| Desktop Build | Vite | 6.2.0 | 构建工具 |
| Desktop Shell | Tauri | 2.4.0 | 桌面运行时（Rust） |
| CSS | Tailwind CSS | 3.4.17 | 原子化 CSS |
| UI 基础 | Radix UI | v1-2 | 无样式可访问性原语 |
| 组件变体 | class-variance-authority | 0.7.1 | 变体管理 |
| 状态管理 | Zustand | 5.0.3 | 轻量级 Store |
| 路由 | React Router | 7.3.0 | 客户端路由 |
| i18n | i18next | 25.6.0 | 国际化 |
| Hub 框架 | Fastify | 5.2.1 | Node.js HTTP |
| Hub DB | node:sqlite (DatabaseSync) | 内置 | SQLite 驱动 |
| Hub 校验 | Zod | 3.24.2 | Schema 校验 |
| Hub 日志 | Pino | 9.6.0 | 结构化日志 |
| Worker 框架 | FastAPI | 0.115.11+ | Python HTTP |
| Worker DB | aiosqlite | 0.21.0+ | 异步 SQLite |
| Agent 编排 | LangGraph | 0.5.0+ | 图状态机 |
| Agent 规划 | DeepAgents | 0.0.8+ | 深度规划 |
| LLM SDK | openai 1.66+ / anthropic 0.49+ | - | 模型调用 |
| 协议 | JSON Schema v2 + AJV | 8.17.1 | Schema 校验+代码生成 |
| 构建编排 | Turbo | 2.4.4 | Monorepo 构建 |
| 包管理 | pnpm | 10.11.0 | 依赖管理 |

---

## 1. 逐层评估

### 1.1 Desktop — Tauri + React + Zustand + Tailwind

#### 保持不变（合理）

| 技术 | 理由 |
|------|------|
| **Tauri 2.4** | 轻量高性能桌面运行时，Rust 后端安全可靠，Keychain 集成。Electron 唯一优势是生态更大，但 Tauri 2 已足够成熟 |
| **React 19** | 最新稳定版，生态第一，v0.2.0 不需要迁移框架 |
| **Vite 6** | 最快的构建工具，HMR 极佳，与 Tauri 集成良好 |
| **Zustand 5** | 轻量、灵活、TypeScript 友好。v0.2.0 的 store 复杂度（workspace/session/execution/permission）Zustand 完全胜任。不需要 Redux/Jotai/MobX |
| **React Router 7** | 稳定可靠。TanStack Router 类型更好但迁移无明确收益 |
| **i18next 25** | 国际化标准库，功能完整 |
| **Lucide React** | 一致性好的图标库，体积小 |

#### 建议调整

| 当前 | 建议 | 理由 |
|------|------|------|
| **Tailwind CSS 3.4** | **保持 3.x，不升 v4** | Tailwind v4 (2025.01 发布) 是 CSS-first 全新配置模型，迁移工作量大。v0.2.0 已是彻底重构，不应同时迁移 CSS 框架。v3 功能完全够用。待 v0.2.0 稳定后再考虑 v4 |
| **Radix UI (散装)** | **引入 shadcn/ui 模式** | 当前已有 `src/components/ui/` 用 CVA + Radix 的模式，这就是 shadcn/ui 的核心理念。建议直接采用 shadcn/ui 的组件模板作为基础，减少自建组件的工作量。注意：shadcn/ui 不是 npm 包，是复制到项目中的代码模板，完全可控 |
| **无 EventSource 库** | **引入 eventsource-parser** | 当前用浏览器原生 EventSource，不支持 POST 请求和自定义 header。v0.2.0 SSE 需要携带 Bearer token + workspace_id，建议用 fetch + eventsource-parser 替代原生 EventSource |
| **无 React Query** | **引入 @tanstack/react-query** | v0.2.0 hub-first 架构意味着大量 HTTP 请求（sessions/projects/skills/mcp/model-configs）。React Query 提供：自动缓存/失效、乐观更新、loading/error 状态管理、请求去重。减少大量 boilerplate |

**评估细节——React Query vs 手动 fetch**：

```
v0.2.0 需要与 Hub 交互的数据列表：
- Workspaces (列表/切换)
- Projects (列表/CRUD/sync状态)
- Sessions (列表/CRUD/配置)
- Model Configs (列表/CRUD)
- Skill Sets (列表/CRUD)
- MCP Connectors (列表/CRUD)
- Navigation (菜单树)
- Execution Events (SSE 流)
- Confirmations (create/approve/deny)

手动管理每个数据源的 loading/error/cache/refetch
→ 大量重复代码 + 容易出错

React Query 自动处理：
- staleTime/cacheTime 配置
- 自动后台刷新
- 请求去重
- 乐观更新（mutation + invalidation）
- Suspense 集成（可选）
```

#### 最终 Desktop 技术栈

```
Framework:    React 19 + TypeScript 5.8
Desktop:      Tauri 2.4
Build:        Vite 6
State:        Zustand 5 (client state) + React Query (server state)
Routing:      React Router 7
Styling:      Tailwind CSS 3.4 + shadcn/ui 模式
Components:   Radix UI + CVA + tailwind-merge
i18n:         i18next 25
SSE:          fetch + eventsource-parser
Icons:        Lucide React
```

---

### 1.2 Hub Server — Fastify + SQLite

#### 保持不变（合理）

| 技术 | 理由 |
|------|------|
| **Fastify 5** | 高性能 Node.js 框架，内置 schema 校验、插件系统优秀、SSE 支持良好。不需要切换到 Express/Koa/Hono |
| **Zod 3** | TypeScript 优先的 schema 校验，已在使用，与 Fastify 集成良好 |
| **Pino 9** | Fastify 默认日志库，结构化日志，性能极佳 |
| **TypeScript 5.8** | 维持一致 |

#### 必须调整

| 当前 | 建议 | 理由 |
|------|------|------|
| **node:sqlite (DatabaseSync)** | **引入 Drizzle ORM + better-sqlite3 / postgres** | **这是最关键的调整**。原因如下 |

**为什么必须调整 DB 层**：

v0.2.0 TECH_ARCH 明确要求："建议 Postgres；单机可 SQLite"。当前 `node:sqlite` (DatabaseSync) 存在以下问题：

1. **只支持 SQLite**：无法支持团队模式的 Postgres。v0.2.0 remote hub 需要 Postgres 作为生产级数据库
2. **同步 API**：`DatabaseSync` 是 Node.js 内置同步 SQLite API，在高并发下可能阻塞事件循环
3. **生态不成熟**：node:sqlite 是相对较新的内置模块，better-sqlite3 有更长的生产验证历史
4. **无迁移工具**：当前手写 SQL migration 文件 + 手动执行。v0.2.0 表结构大幅增加，需要可靠的迁移工具

**推荐方案：Drizzle ORM**

```
为什么选 Drizzle 而非 Kysely/Prisma/TypeORM：

Drizzle ORM:
✅ 类型安全的 SQL-like 查询（贴近原生 SQL，学习成本低）
✅ 同时支持 SQLite (better-sqlite3/libsql) 和 Postgres (pg/postgres.js)
✅ Drizzle Kit 提供迁移生成+执行
✅ 零运行时依赖（轻量）
✅ Schema 定义即 TypeScript（双重用途：类型 + 迁移源）
✅ 支持 prepare statement（性能好）
✅ 事务支持（session mutex 关键）

Kysely（备选）:
✅ 类型安全 query builder
✅ 双 dialect 支持
❌ 无迁移工具（需搭配 kysely-ctl 或自建）
❌ API 稍冗长

Prisma:
❌ 生成大量代码，bundle 体积大
❌ 对 SQLite 支持有限制（如无 advisory lock）
❌ 性能开销较大

TypeORM:
❌ 类型不够安全
❌ 维护频率下降
❌ 不推荐用于新项目
```

**Drizzle 实施方案**：

```typescript
// drizzle/schema.ts — 统一 Schema 定义
import { sqliteTable, text, integer } from 'drizzle-orm/sqlite-core';
// 或
import { pgTable, text, integer } from 'drizzle-orm/pg-core';

// 通过环境变量或配置选择 dialect:
// GOYAIS_HUB_DB_DIALECT=sqlite | postgres
// GOYAIS_HUB_DB_URL=file:./data/hub.db | postgres://...

export const sessions = sqliteTable('sessions', {
  sessionId: text('session_id').primaryKey(),
  workspaceId: text('workspace_id').notNull(),
  // ...
});

// drizzle.config.ts — 迁移配置
export default {
  schema: './src/db/schema.ts',
  out: './drizzle',
  dialect: process.env.GOYAIS_HUB_DB_DIALECT ?? 'sqlite',
};
```

**迁移策略**：
- 现有 `migrations/0001-0003.sql` → 转换为 Drizzle schema 定义
- 新增 v0.2.0 表直接在 Drizzle schema 中定义
- `drizzle-kit generate` 生成迁移 + `drizzle-kit migrate` 执行
- 保留手写 SQL 作为 seed 数据

| 当前 | 建议 | 理由 |
|------|------|------|
| **无定时任务** | **引入 node-cron 或自建 interval** | v0.2.0 需要 execution timeout watchdog（每 30s 扫描超时）、worktree GC。轻量选择：`setInterval` 即可，无需 heavy 库 |
| **无 WebSocket** | **考虑 @fastify/websocket** | Worker → Hub 事件上报可用 HTTP POST，但 WebSocket 能降低延迟和开销。初期 HTTP POST 即可，预留 WebSocket 升级路径 |

#### 最终 Hub Server 技术栈

```
Framework:    Fastify 5
Language:     TypeScript 5.8
ORM:          Drizzle ORM (sqlite + postgres dual dialect)
DB Driver:    better-sqlite3 (local) / pg (remote)
Validation:   Zod 3
Logging:      Pino 9
Migration:    Drizzle Kit
Auth:         Custom token-based (已实现)
Encryption:   Node.js crypto (AES-256-GCM，已实现)
```

---

### 1.3 Runtime/Worker — FastAPI + LangGraph

#### 保持不变（合理）

| 技术 | 理由 |
|------|------|
| **FastAPI** | Python 异步 Web 框架标配，性能好，自带 OpenAPI，与 Pydantic 深度集成 |
| **LangGraph 0.5** | Agent 编排标准选择。图状态机模型天然适合 plan/agent 两种模式。v0.2.0 的 plan → confirm → execute 流程就是 LangGraph 的典型场景 |
| **httpx** | 异步 HTTP 客户端，用于上报事件到 Hub 和调用 MCP，优秀选择 |
| **Pydantic 2** | 数据校验和序列化标准库 |
| **sse-starlette** | SSE 推送库（v0.2.0 中 worker 不再直接推 SSE 给客户端，但内部可能仍需要） |
| **openai / anthropic SDK** | LLM 提供商 SDK，必须保留 |

#### 建议调整

| 当前 | 建议 | 理由 |
|------|------|------|
| **DeepAgents 0.0.8** | **评估是否移除** | DeepAgents 版本 0.0.8 极其早期，API 不稳定。LangGraph 0.5 已经足够实现 plan/agent 两种模式的状态机。如果 DeepAgents 仅用于 "深度规划" 能力，建议先用 LangGraph 的 subgraph 替代，避免对不稳定依赖的强耦合。如果 DeepAgents 有不可替代的功能（如多层规划+反思），则固定版本并隔离调用 |
| **aiosqlite** | **降级为可选** | v0.2.0 worker 成为无状态受控进程。Hub 为数据权威，worker 不需要本地 SQLite。aiosqlite 仅用于本地缓存/临时状态（如果需要）。可以保留依赖但不再作为核心存储 |
| **无 MCP SDK** | **引入 mcp Python SDK** | v0.2.0 需要 worker 调用 MCP connectors。需要 `mcp` Python 包（Anthropic 官方 MCP SDK）来实现 stdio/SSE/streamable-http 传输 |
| **pytest** | **增加 pytest-httpx** | v0.2.0 worker 大量使用 httpx 调用 Hub API，需要 mock httpx 请求的测试工具 |

**DeepAgents 评估详情**：

```
DeepAgents 0.0.8 的潜在风险：
1. 版本 <1.0，API 可能随时 breaking change
2. 社区小，遇到 bug 无法快速修复
3. 可能与 LangGraph 0.5 的 API 不兼容（依赖冲突）

LangGraph 0.5 已能实现的功能：
- StateGraph 支持条件分支（plan/agent 模式切换）
- 子图（subgraph）支持嵌套规划
- 中断点（interrupt）支持等待人工确认
- 检查点（checkpointing）支持执行恢复
- Tool 节点支持工具调用

建议：
- 如果 DeepAgents 仅作为 "高级规划" 的实验性功能 → 隔离在单独模块中，可选启用
- 如果核心执行流依赖 DeepAgents → 风险过高，建议用 LangGraph 原生功能替代
```

#### 最终 Runtime/Worker 技术栈

```
Framework:    FastAPI 0.115+
Server:       Uvicorn 0.34+
Agent:        LangGraph 0.5+ (核心编排)
              DeepAgents 0.0.8+ (可选，隔离使用)
LLM:          openai 1.66+ / anthropic 0.49+
MCP:          mcp SDK (新增)
HTTP:         httpx 0.28+ (Hub 通信)
Validation:   Pydantic 2.10+
JSON:         orjson 3.10+
DB:           aiosqlite (降级为可选，仅缓存)
Test:         pytest + pytest-asyncio + pytest-httpx (新增)
Lint:         ruff 0.11+
```

---

### 1.4 Protocol — JSON Schema + 代码生成

#### 保持不变

| 技术 | 理由 |
|------|------|
| **JSON Schema** | 语言无关的 schema 定义，适合跨 TS/Python 项目 |
| **AJV 8** | 最快的 JSON Schema 校验器 |
| **json-schema-to-typescript** | 成熟的 TS 类型生成器 |

#### 建议调整

| 当前 | 建议 | 理由 |
|------|------|------|
| **Python 生成脚本读 v1** | **统一到 v2** | 已知问题，Phase 0 立即修复 |
| **手动生成脚本** | **考虑 openapi-typescript-codegen 或保持现状** | 当前方案够用。如果 Hub API 变多，可考虑 OpenAPI spec → 自动生成客户端。但 v0.2.0 先保持手动 |

#### 最终 Protocol 技术栈

```
Schema:       JSON Schema v2 (不变)
TS Codegen:   json-schema-to-typescript 15 (不变)
Py Codegen:   自定义脚本 (修复到 v2)
Validation:   AJV 8 (TS) / jsonschema 4 (Python) (不变)
```

---

### 1.5 构建与工程化

#### 保持不变

| 技术 | 理由 |
|------|------|
| **pnpm 10** | 快速、磁盘高效的包管理器 |
| **Turbo 2.4** | 增量构建缓存，monorepo 任务编排 |
| **ESLint 9 + Prettier** | 代码质量标配 |

#### 建议调整

| 当前 | 建议 | 理由 |
|------|------|------|
| **CI 无质量闸门** | **pre-commit hook + CI pipeline** | v0.2.0 需要 typecheck + lint 全绿作为发布阻断条件。建议用 `husky` + `lint-staged` 作为 pre-commit，CI 中强制 `pnpm test && pnpm typecheck && pnpm lint` |

---

## 2. 总结：需要调整的技术选型

### 必须调整（P0）

| 变更 | 影响范围 | 理由 |
|------|---------|------|
| **Hub Server: TypeScript/Fastify → Go 重写** | Hub Server 全部 | 单二进制部署、goroutine 并发模型、Tauri sidecar 友好、5 年长期最优。详见 `v0.2.0_LANG_ARCHITECTURE_DECISION.md` |
| **Hub DB: sqlc + go-sqlite3/pgx + goose** | Hub Server 数据层 | Go 生态中 sqlc 是 SQL-first 类型安全查询的最佳选择；支持 SQLite + Postgres 双 dialect |
| **Desktop: 引入 @tanstack/react-query** | Desktop API 层 | hub-first 架构下大量 HTTP 请求需要统一的缓存/状态管理 |
| **Desktop: SSE 改用 fetch + eventsource-parser** | Desktop SSE 层 | 需要自定义 header（Bearer token）和 POST 支持 |
| **Protocol: Python + Go 生成统一到 v2** | Protocol 包 | 已知缺陷修复 + 新增 Go 类型生成 |

### 建议调整（P1）

| 变更 | 影响范围 | 理由 |
|------|---------|------|
| **Desktop: 引入 shadcn/ui 模式** | Desktop 组件库 | 减少自建组件工作量，当前已有类似模式 |
| **Worker: DeepAgents 保留但隔离** | Agent 编排 | LangGraph 0.5 为默认，DeepAgents 可选模块 |
| **Worker: 引入 mcp Python SDK** | MCP 连接器 | v0.2.0 Skills/MCP 功能需要 |
| **Worker: 引入 pytest-httpx** | 测试 | Worker 大量 httpx 调用 Hub 需要 mock |
| **工程化: husky + lint-staged** | CI/CD | 代码质量闸门 |

### 不调整（维持现状）

| 技术 | 理由 |
|------|------|
| Tauri 2.4 | 桌面运行时无需更换 |
| React 19 + Vite 6 | 最新稳定版 |
| Zustand 5 | 客户端状态完全够用 |
| React Router 7 | 稳定可靠 |
| Tailwind CSS 3.4 | 不在重构同时升 v4 |
| FastAPI | Python async Web 标配 |
| LangGraph 0.5 | Agent 编排核心 |
| openai/anthropic SDK | LLM 必须 |
| JSON Schema + AJV | 跨语言协议 |
| pnpm + Turbo | 构建系统不变 |

---

## 3. Drizzle ORM 迁移方案（详细）

这是最大的技术变更，单独详述。

### 3.1 为什么是 Drizzle

```
项目需求匹配度：

1. 双 Dialect 支持
   - 本地模式: better-sqlite3 (同步，适合单机)
   - 远程模式: pg (Postgres，适合团队)
   - Drizzle 原生支持两者

2. SQL-like API
   - 当前团队已习惯手写 SQL
   - Drizzle 的查询 API 贴近原生 SQL，学习曲线极低
   - 不会像 Prisma 那样引入全新抽象

3. 迁移管理
   - drizzle-kit generate: 从 schema 差异自动生成迁移
   - drizzle-kit migrate: 执行迁移
   - 支持自定义迁移（复杂数据变换）

4. 类型安全
   - Schema 定义即 TypeScript 类型
   - 查询结果自动推导类型
   - compile-time 错误而非 runtime 错误

5. 轻量
   - 零运行时依赖
   - bundle 体积远小于 Prisma
   - 对 Tauri 本地 hub 场景友好
```

### 3.2 实施步骤

```
Phase 0 中执行：

1. 安装依赖：
   pnpm add drizzle-orm better-sqlite3 pg
   pnpm add -D drizzle-kit @types/better-sqlite3 @types/pg

2. 定义 Schema（src/db/schema/）：
   - auth.ts (users, auth_tokens)
   - workspace.ts (workspaces, workspace_members, roles, permissions...)
   - project.ts (projects)
   - session.ts (sessions, executions, execution_events)
   - model.ts (model_configs, secrets)
   - skill.ts (skill_sets, skills, mcp_connectors)
   - audit.ts (audit_logs, tool_confirmations)

3. 初始化 Drizzle 客户端：
   - src/db/index.ts: 根据 GOYAIS_HUB_DB_DIALECT 选择 dialect
   - src/db/sqlite.ts: better-sqlite3 初始化
   - src/db/postgres.ts: pg Pool 初始化

4. 迁移现有数据：
   - 从现有 0001-0003.sql 生成等价 Drizzle schema
   - drizzle-kit generate 验证无差异
   - 新增 v0.2.0 表定义

5. 重构现有 db.ts：
   - 将 HubDatabase 类的方法逐步替换为 Drizzle 查询
   - 保持接口不变，内部实现替换
```

### 3.3 示例代码

```typescript
// src/db/schema/session.ts
import { sqliteTable, text, integer } from 'drizzle-orm/sqlite-core';
import { users } from './auth';
import { workspaces } from './workspace';
import { projects } from './project';

export const sessions = sqliteTable('sessions', {
  sessionId: text('session_id').primaryKey(),
  workspaceId: text('workspace_id').notNull().references(() => workspaces.workspaceId),
  projectId: text('project_id').notNull().references(() => projects.projectId),
  title: text('title').notNull().default('New Session'),
  mode: text('mode', { enum: ['plan', 'agent'] }).notNull().default('agent'),
  modelProfileId: text('model_profile_id'),
  skillSetIds: text('skill_set_ids').default('[]'),
  mcpConnectorIds: text('mcp_connector_ids').default('[]'),
  activeExecutionId: text('active_execution_id'),
  status: text('status', { enum: ['idle', 'executing', 'waiting_confirmation'] }).notNull().default('idle'),
  createdBy: text('created_by').notNull().references(() => users.userId),
  createdAt: text('created_at').notNull().$defaultFn(() => new Date().toISOString()),
  updatedAt: text('updated_at').notNull().$defaultFn(() => new Date().toISOString()),
  archivedAt: text('archived_at'),
});

// src/db/index.ts
import { drizzle as drizzleSqlite } from 'drizzle-orm/better-sqlite3';
import { drizzle as drizzlePg } from 'drizzle-orm/node-postgres';
import Database from 'better-sqlite3';
import { Pool } from 'pg';

export function createDb(config: { dialect: 'sqlite' | 'postgres'; url: string }) {
  if (config.dialect === 'sqlite') {
    const sqlite = new Database(config.url);
    sqlite.pragma('journal_mode = WAL');
    sqlite.pragma('foreign_keys = ON');
    return drizzleSqlite(sqlite);
  } else {
    const pool = new Pool({ connectionString: config.url });
    return drizzlePg(pool);
  }
}

// 使用示例 — Session Mutex
import { eq, isNull } from 'drizzle-orm';

async function acquireSessionLock(db, sessionId: string, executionId: string) {
  // SQLite: 事务内 check-and-set
  return db.transaction((tx) => {
    const session = tx.select().from(sessions).where(eq(sessions.sessionId, sessionId)).get();
    if (session.activeExecutionId !== null) {
      throw new SessionBusyError(session.activeExecutionId);
    }
    tx.update(sessions)
      .set({ activeExecutionId: executionId, status: 'executing' })
      .where(eq(sessions.sessionId, sessionId))
      .run();
  });
}
```

---

## 4. React Query 引入方案

### 4.1 职责划分

```
Zustand (客户端状态):
- 当前 workspace/profile 选择
- UI 状态（sidebar 展开/折叠、主题、语言）
- 当前 session 选择
- 执行过程中的临时状态

React Query (服务端状态):
- Sessions 列表 (GET /v1/sessions)
- Projects 列表 (GET /v1/projects)
- Model Configs 列表 (GET /v1/model-configs)
- Skill Sets 列表 (GET /v1/skill-sets)
- MCP Connectors 列表 (GET /v1/mcp-connectors)
- Navigation 菜单 (GET /v1/me/navigation)
- Workspace 列表 (GET /v1/workspaces)
- Execution 历史 (GET /v1/executions)
```

### 4.2 示例

```typescript
// hooks/useSessionsQuery.ts
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { hubClient } from '@/api/hubClient';

export function useSessions(workspaceId: string, projectId: string) {
  return useQuery({
    queryKey: ['sessions', workspaceId, projectId],
    queryFn: () => hubClient.sessions.list(workspaceId, projectId),
    staleTime: 30_000, // 30s 内不重新请求
  });
}

export function useCreateSession() {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: hubClient.sessions.create,
    onSuccess: (_, variables) => {
      queryClient.invalidateQueries({
        queryKey: ['sessions', variables.workspaceId],
      });
    },
  });
}
```

---

## 5. 最终技术栈全景

```
┌─────────────────────────────────────────────────────┐
│                    Desktop (Tauri 2.4)               │
│  React 19 + Vite 6 + TypeScript 5.8                │
│  Zustand 5 (client) + React Query (server state)    │
│  Tailwind 3.4 + shadcn/ui + Radix UI + Lucide      │
│  React Router 7 + i18next 25                        │
│  fetch + eventsource-parser (SSE)                   │
└──────────────────┬──────────────────────────────────┘
                   │ HTTP + SSE
┌──────────────────▼──────────────────────────────────┐
│               Hub Server (Go 1.23+)                  │
│  net/http + chi router (或 Echo)                     │
│  sqlc (SQL-first 类型安全查询)                        │
│  go-sqlite3 (local) / pgx (remote)                  │
│  goose (migration) + slog (logging)                  │
│  crypto/aes (AES-256-GCM secrets) + RBAC            │
│  goroutine-per-SSE-connection                        │
│  单一静态二进制 → Tauri sidecar                       │
└──────────────────┬──────────────────────────────────┘
                   │ Internal HTTP (X-Hub-Auth)
┌──────────────────▼──────────────────────────────────┐
│            Worker (FastAPI 0.115+)                    │
│  Python 3.11+ + Pydantic 2 + httpx                  │
│  LangGraph 0.5 (agent orchestration, 默认)           │
│  DeepAgents 0.0.8 (可选, 隔离模块)                    │
│  openai + anthropic SDK + mcp SDK                   │
│  Tools: file/patch/command/git/mcp                   │
│  aiosqlite (optional cache only)                    │
└─────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────┐
│              Protocol (JSON Schema v2)               │
│  AJV 8 (TS) + jsonschema 4 (Python)                │
│  json-schema-to-typescript + Go struct codegen      │
└─────────────────────────────────────────────────────┘

Build: pnpm 10 + Turbo 2.4 + Go toolchain + husky + lint-staged
```

---

## 6. 新增/变更依赖清单

### Desktop (apps/desktop-tauri/package.json)

```json
{
  "dependencies": {
    "@tanstack/react-query": "^5.x",        // 新增：服务端状态管理
    "eventsource-parser": "^3.x"             // 新增：SSE 解析（替代原生 EventSource）
  }
}
```

### Hub Server — Go 重写 (server/hub-server-go/go.mod)

```go
// 核心依赖
github.com/go-chi/chi/v5          // HTTP 路由（或 github.com/labstack/echo/v4）
github.com/jackc/pgx/v5           // Postgres 驱动
github.com/mattn/go-sqlite3       // SQLite 驱动
github.com/sqlc-dev/sqlc          // SQL → Go 代码生成（dev tool）
github.com/pressly/goose/v3       // 数据库迁移
github.com/go-playground/validator/v10  // 请求校验
github.com/caarlos0/env/v11       // 环境变量配置
github.com/stretchr/testify       // 测试断言
golang.org/x/crypto               // bcrypt 密码哈希
```

移除整个 `server/hub-server/`（TypeScript 版本归档）

### Runtime/Worker (runtime/python-agent/pyproject.toml)

```toml
[project]
dependencies = [
    "mcp>=1.0",              # 新增：MCP SDK
]

[project.optional-dependencies]
dev = [
    "pytest-httpx>=0.30",    # 新增：httpx mock
]
```

评估移除：`deepagents>=0.0.8`（如确认 LangGraph 可替代）

### Root (package.json)

```json
{
  "devDependencies": {
    "husky": "^9.x",                        // 新增：Git hooks
    "lint-staged": "^15.x"                   // 新增：Pre-commit lint
  }
}
```
