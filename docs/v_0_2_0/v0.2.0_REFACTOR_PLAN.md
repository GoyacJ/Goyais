# Goyais v0.2.0 重构计划

角色：首席架构师
日期：2026-02-21
性质：**彻底重构，不考虑向后兼容**
状态：**✅ v0.2.0 全部重构工作已完成 (2026-02-21)**

---

## 0. 概述

### 0.1 v0.2.0 核心变革

v0.1.0 → v0.2.0 的本质变化是 **"Run-Centric → Session-Centric + Hub-First"**：

| 维度 | v0.1.0 | v0.2.0 |
|------|--------|--------|
| 核心概念 | `Run` 是用户可见执行单元 | `Session` 是唯一用户可见概念，`Run` 变为内部 `Execution` |
| 数据权威 | Runtime 自治（session/run/event 全在 runtime SQLite） | Hub 为权威（session/execution/event 存 Hub DB） |
| 执行模型 | Desktop 直连 runtime 创建 run | Desktop → Hub → Worker，Hub 主控调度 + session mutex |
| 本地模式 | Desktop 直连 runtime，不经过 hub | **统一 hub-first**，local 也走 local hub → local worker |
| 会话约束 | 无互斥，可多 run 并行 | **会话同一时间仅允许一个执行**（硬约束） |

### 0.2 关键决策

1. **Skills/MCP**：v0.2.0 必须包含（Hub 表 + API + Worker 注入 + Desktop UI）
2. **Local 架构**：统一 hub-first，彻底消除 local/remote 代码分叉
3. **实施方式**：分 Phase 渐进式，每个 Phase 有可运行 milestone
4. **执行排队**：v0.2.0 out of scope（PRD 标注"可选"），仅提供 Cancel / New Session
5. **事件存储**：Hub 为权威存储，Worker 不本地持久化（仅内存 buffer 用于重试）
6. **Hub 语言**：**Go 重写**（单二进制部署、goroutine SSE、Tauri sidecar 友好）
7. **Hub DB**：sqlc（SQL-first 类型安全）+ go-sqlite3（local）/ pgx（remote）+ goose（迁移）
8. **Agent 框架**：LangGraph 0.5 为默认编排框架，DeepAgents 保留但隔离为可选模块
9. **Desktop 状态**：Zustand（客户端）+ React Query（服务端状态），SSE 用 fetch + eventsource-parser

> 详细技术选型评审见 `v0.2.0_TECH_STACK_REVIEW.md`
> 语言决策详情见 `v0.2.0_LANG_ARCHITECTURE_DECISION.md`

---

## 1. 差距分析（Gap Analysis）

### 1.1 Hub Server 缺口

| 缺口 | 说明 | 复杂度 |
|------|------|--------|
| Sessions 表 + CRUD | mode/model_profile_id/skill_set_ids/mcp_connector_ids/active_execution_id/status | **L** |
| Executions 表 + 调度 | session mutex + 创建 execution + 计算 context + 分配 worker | **XL** |
| Events 表 + 上报 + SSE | 接收 worker 事件 POST → 写 DB → 推 SSE 给客户端 | **L** |
| Execute API | `POST /v1/sessions/{id}/execute` + 409 SESSION_BUSY | **L** |
| Commit/Patch API | `POST /v1/executions/{id}/commit` + `GET /v1/executions/{id}/patch` | **M** |
| Timeout Watchdog | Worker 崩溃后自动清理 session mutex | **M** |
| Skills/MCP 表 + API | skill_sets / skills / mcp_connectors CRUD + 权限 | **L** |
| Projects 扩展 | repo_url/branch/auth_ref/repo_cache_path/status + clone/sync service | **M** |
| Workspace 配额 | workspace/project/user 并发执行上限 | **S** |

### 1.2 Runtime/Worker 缺口

| 缺口 | 说明 | 复杂度 |
|------|------|--------|
| RunService → ExecutionService | 从自治转为受控 worker，接收 Hub 调度 | **L** |
| Session/Run CRUD 移除 | Hub 接管，runtime 不再管理 session | **L** |
| 事件上报改造 | 从本地 EventBus 改为 `POST /internal/executions/{id}/events` 到 Hub | **L** |
| Worktree 管理 | `git worktree add/remove`，执行目录切换，清理策略 | **M** |
| Git commit | GIT_AUTHOR_*/GIT_COMMITTER_* 设置 + worktree 内 commit | **M** |
| Plan 模式状态机 | plan → 等待 plan 确认 → execute tools → done | **M** |
| Skills/MCP 注入 | 从 execution context 获取配置 → 注入 agent tool set | **L** |

### 1.3 Desktop 缺口

| 缺口 | 说明 | 复杂度 |
|------|------|--------|
| Store 重构 | `runStore` → `executionStore`，`runId` → `executionId` | **L** |
| ConversationPage 重写 | session execute 替代 createRun + session events SSE | **XL** |
| DataSource 统一 | 消除 local/remote 分叉，统一走 hub-first | **L** |
| SSE 订阅改造 | 从 run events 改为 session events | **M** |
| Session 创建对话框 | mode/model/skills/MCP/worktree 选择 | **M** |
| 会话 busy 处理 | 409 弹窗：cancel current / new session | **S** |
| Git commit UI | Commit 按钮 + SHA 展示 + Patch 导出按钮 | **M** |
| Skills/MCP 管理 | Settings 面板 + 会话创建选择器 | **M** |
| i18n 新增 | session busy / execution 状态 / worktree / capability prompt 等 | **S** |

### 1.4 Protocol 缺口

| 缺口 | 说明 | 复杂度 |
|------|------|--------|
| Event envelope 升级 | `run_id` → `execution_id`，增加 `session_id` | **S** |
| 新增事件类型 | `text_delta`（流式思考）、`confirmation_request`/`confirmation_decision` | **S** |
| Python 生成脚本 | 统一从 `schemas/v2` 生成 | **S** |

---

## 2. PRD/TECH_ARCH 补充建议

### 2.1 需要补充的设计细节

#### A. Worker → Hub 事件上报机制

**问题**：TECH_ARCH 3.3 说"Hub 推送事件给客户端"，但未定义 Worker 如何上报事件到 Hub。

**建议方案**：
```
Worker --[POST /internal/executions/{id}/events (batch)]--> Hub
Hub: 写 events 表 + 推送到 SSE 客户端

请求格式：
POST /internal/executions/{execution_id}/events
X-Hub-Auth: <shared_secret>
Body: {
  "events": [
    { "seq": 1, "ts": "...", "type": "plan", "payload": {...} },
    { "seq": 2, "ts": "...", "type": "tool_call", "payload": {...} }
  ]
}
```

v0.2.0 用 HTTP POST 批量上报足够。后续可升级 WebSocket/gRPC stream 降低延迟。

#### B. Execution Timeout Watchdog

**问题**：Worker 崩溃 → Hub 的 `active_execution_id` 永远不会被清理 → Session 永久 busy。

**建议方案**：
```
Hub 后台任务（每 30s 运行一次）：
1. 查询所有 state='executing' 且 last_event_ts < now() - TIMEOUT 的 execution
2. 标记 execution.state = 'failed'，记录 reason = 'timeout_no_heartbeat'
3. 清理 session.active_execution_id = NULL
4. 写 audit_log
5. 推送 error event 到 SSE（通知客户端）

Worker 端：
- 每 15s 发送 heartbeat event（type='heartbeat'，不存 DB，仅更新 last_event_ts）
- 建议 TIMEOUT = 120s（可配置）
```

#### C. Local Hub-First 启动流程

**问题**：当前 Desktop 直连 runtime，v0.2.0 统一走 local hub 需要明确启动流程。

**建议方案**：
```
Tauri Supervisor 启动顺序：
1. 启动 Local Hub（localhost:随机端口）
   - auto bootstrap admin（无密码/预置 token）
   - 创建 default local workspace
   - 初始化 SQLite DB
2. 启动 Local Worker（localhost:随机端口）
   - 设置 GOYAIS_HUB_BASE_URL=http://localhost:{hub_port}
   - 自动注册到 local hub
3. Desktop UI 启动
   - base_url = http://localhost:{hub_port}
   - 使用 auto-bootstrap token 认证
   - 与 remote 模式使用完全相同的 API 路径

健康检查：Supervisor 每 5s ping /v1/health，失败自动重启
退出清理：关闭 Desktop 时依次停止 Worker → Hub
```

#### D. 执行排队 → 明确 Out of Scope

**问题**：PRD 6.5 提到会话忙时可"排队（需明确选择）"，实现需要 Hub 维护执行队列。

**建议**：v0.2.0 仅实现两个选项：
1. **Cancel current**：取消当前执行 + 开始新指令
2. **New session**：新建会话执行

排队功能延迟到 v0.3.0。

#### E. 事件存储策略

| 场景 | 权威存储 | Worker 行为 |
|------|---------|------------|
| Remote 模式 | Remote Hub DB | 上报到 Hub，不本地持久化 |
| Local 模式 | Local Hub DB | 同上（local hub 也是 Hub） |
| Worker 内存 | 仅 buffer | 用于 batch 上报 + 失败重试（最多 1000 条 ring buffer） |

### 2.2 借鉴主流工具的体验建议

| 模式 | 来源 | 说明 | 建议 |
|------|------|------|------|
| **Streaming Markdown** | Claude Code | 终端输出是 streaming markdown rendering | 增加 `text_delta` 事件类型，流式展示 agent 思考过程（当前是 summarize 模式） |
| **Inline Diff** | Cursor | Diff 直接嵌入代码编辑区 | Diff 作为 conversation 流的一部分展示（可折叠），而非仅在右侧面板 |
| **Tool Call Grouping** | Cursor | 相关 tool call 分组展示 | 按阶段分组：read → plan → patch → apply，折叠展示细节 |
| **Discard Changes** | Claude Code | `git checkout .` 回滚 | Worktree 中提供 "Discard" 按钮，是 worktree 隔离的自然延伸 |
| **Cost Display** | Claude Code | 每次执行显示 token 用量/费用 | 在 execution 完成后显示 token 统计（input/output/total） |

---

## 3. 风险评估

### Risk 1: Hub 成为权威 → 数据流 180 度翻转（HIGH）

**描述**：Session/Execution/Event 全部从 runtime 迁到 hub。如果迁移不彻底，会出现 Hub 和 Worker 状态不一致。

**缓解**：
- 严格分 Phase，每个 Phase 有可运行 milestone
- Phase 2 是核心风险点，预留最多时间
- 集成测试覆盖：session 创建 → execute → events 流转 → completion → mutex 释放

### Risk 2: Session Mutex 分布式正确性（HIGH）

**描述**：单机 SQLite 用事务锁可行，Postgres 需要行级锁。

**缓解**：
- SQLite：`BEGIN IMMEDIATE` + check-and-set `active_execution_id`
- Postgres：`SELECT ... FOR UPDATE` on sessions row
- Hub 抽象 `acquireSessionLock(sessionId)` 接口，底层可切换实现
- 增加幂等 check：worker 开始执行前确认 execution 仍为 active

### Risk 3: SSE 断线重连与事件有序性（MEDIUM）

**描述**：Hub 存储 + 推送模式下，客户端断线后需要续传。

**缓解**：
- 事件带 `seq`（自增），SSE 设置 `id: {seq}`
- 客户端重连时发送 `Last-Event-ID`
- Hub SSE endpoint 支持 `?since_seq=N` 从指定位置续传
- Hub 内存缓存最近 500 条事件（ring buffer），超出从 DB 读

### Risk 4: Worktree 文件系统泄漏（MEDIUM）

**描述**：Worker pool 场景下 worktree 清理不彻底，磁盘泄漏。

**缓解**：
- 执行结束（success/fail）→ finally 块清理 worktree
- 失败时保留 worktree（默认），但标记 `cleanup_after` 时间
- Hub 后台任务：定期扫描过期 worktree 并清理
- 管理 API：`GET /admin/worktrees`、`DELETE /admin/worktrees/{id}`

### Risk 5: 开发范围膨胀（HIGH）

**描述**：多个 XL 特性并行（概念重命名 + session mutex + worktree + git commit + skills/mcp + hub-first）。

**缓解**：
- 严格按 Phase 推进，每个 Phase 验收后再进入下一个
- Phase 3/4/5/6 可部分并行
- 执行排队明确 defer 到 v0.3.0
- 每个 Phase 定义明确的 "Done" 标准

---

## 4. 分阶段实施计划

### Phase 0: Foundation — Go Hub 骨架 + 数据模型 + 协议升级

**目标**：搭建 Go Hub Server 骨架，建立 v0.2.0 数据模型。

> 注意：Hub 从 TypeScript/Fastify 彻底重写为 Go。不迁移旧代码，从零构建。

**构建内容**：

1. **Go Hub 项目骨架**
   ```
   server/hub-server-go/
   ├── cmd/hub/main.go           # 入口：配置加载 → DB 初始化 → 路由注册 → 启动
   ├── internal/
   │   ├── config/config.go      # 环境变量配置（env tag 映射）
   │   ├── db/
   │   │   ├── sqlite.go         # SQLite 连接（go-sqlite3）
   │   │   ├── postgres.go       # Postgres 连接（pgx）
   │   │   ├── db.go             # DB 接口抽象
   │   │   └── queries/          # sqlc 生成的类型安全查询
   │   ├── handler/              # HTTP handlers（按领域分文件）
   │   ├── service/              # 业务逻辑
   │   ├── middleware/           # Auth/RBAC/Trace/Workspace 中间件
   │   └── model/               # 领域类型
   ├── migrations/               # SQL 迁移文件（goose）
   ├── sqlc.yaml                 # sqlc 配置
   ├── go.mod / go.sum
   └── Makefile
   ```

2. **Hub 数据库迁移（所有表一次性定义）**
   ```sql
   -- 0001_init.sql（包含全部 v0.2.0 表）
   CREATE TABLE sessions (
     session_id TEXT PRIMARY KEY,
     workspace_id TEXT NOT NULL REFERENCES workspaces(workspace_id),
     project_id TEXT NOT NULL REFERENCES projects(project_id),
     title TEXT NOT NULL DEFAULT 'New Session',
     mode TEXT NOT NULL DEFAULT 'agent' CHECK(mode IN ('plan','agent')),
     model_profile_id TEXT REFERENCES model_configs(config_id),
     skill_set_ids TEXT DEFAULT '[]',       -- JSON array
     mcp_connector_ids TEXT DEFAULT '[]',   -- JSON array
     active_execution_id TEXT,              -- NULL = idle, non-NULL = busy
     status TEXT NOT NULL DEFAULT 'idle' CHECK(status IN ('idle','executing','waiting_confirmation')),
     created_by TEXT NOT NULL REFERENCES users(user_id),
     created_at TEXT NOT NULL DEFAULT (datetime('now')),
     updated_at TEXT NOT NULL DEFAULT (datetime('now')),
     archived_at TEXT
   );

   CREATE TABLE executions (
     execution_id TEXT PRIMARY KEY,
     session_id TEXT NOT NULL REFERENCES sessions(session_id),
     project_id TEXT NOT NULL,
     workspace_id TEXT NOT NULL,
     created_by TEXT NOT NULL REFERENCES users(user_id),
     state TEXT NOT NULL DEFAULT 'pending' CHECK(state IN ('pending','executing','waiting_confirmation','completed','failed','cancelled')),
     trace_id TEXT NOT NULL,
     repo_root TEXT,
     worktree_root TEXT,
     use_worktree INTEGER NOT NULL DEFAULT 1,
     user_message TEXT NOT NULL,
     started_at TEXT,
     ended_at TEXT,
     last_event_ts TEXT,
     created_at TEXT NOT NULL DEFAULT (datetime('now'))
   );

   CREATE TABLE execution_events (
     id INTEGER PRIMARY KEY AUTOINCREMENT,
     execution_id TEXT NOT NULL REFERENCES executions(execution_id),
     seq INTEGER NOT NULL,
     ts TEXT NOT NULL,
     type TEXT NOT NULL,
     payload_json TEXT NOT NULL,
     UNIQUE(execution_id, seq)
   );

   CREATE TABLE tool_confirmations (
     confirmation_id TEXT PRIMARY KEY,
     execution_id TEXT NOT NULL REFERENCES executions(execution_id),
     call_id TEXT NOT NULL,
     tool_name TEXT NOT NULL,
     risk_level TEXT NOT NULL DEFAULT 'medium',
     status TEXT NOT NULL DEFAULT 'pending' CHECK(status IN ('pending','approved','denied')),
     decided_by TEXT REFERENCES users(user_id),
     decided_at TEXT,
     created_at TEXT NOT NULL DEFAULT (datetime('now')),
     UNIQUE(execution_id, call_id)
   );

   CREATE TABLE audit_logs (
     audit_id TEXT PRIMARY KEY,
     workspace_id TEXT NOT NULL,
     project_id TEXT,
     session_id TEXT,
     execution_id TEXT,
     user_id TEXT NOT NULL,
     action TEXT NOT NULL,
     tool_name TEXT,
     parameters_summary TEXT,
     outcome TEXT NOT NULL CHECK(outcome IN ('success','failure','denied')),
     trace_id TEXT,
     created_at TEXT NOT NULL DEFAULT (datetime('now'))
   );
   ```

2. **Skills/MCP 表**
   ```sql
   -- 0005_skills_mcp.sql
   CREATE TABLE skill_sets (
     skill_set_id TEXT PRIMARY KEY,
     workspace_id TEXT NOT NULL REFERENCES workspaces(workspace_id),
     name TEXT NOT NULL,
     description TEXT,
     created_by TEXT NOT NULL,
     created_at TEXT NOT NULL DEFAULT (datetime('now'))
   );

   CREATE TABLE skills (
     skill_id TEXT PRIMARY KEY,
     skill_set_id TEXT NOT NULL REFERENCES skill_sets(skill_set_id) ON DELETE CASCADE,
     name TEXT NOT NULL,
     type TEXT NOT NULL,           -- 'tool_combo' | 'template' | 'custom'
     config_json TEXT NOT NULL,
     created_at TEXT NOT NULL DEFAULT (datetime('now'))
   );

   CREATE TABLE mcp_connectors (
     connector_id TEXT PRIMARY KEY,
     workspace_id TEXT NOT NULL REFERENCES workspaces(workspace_id),
     name TEXT NOT NULL,
     transport TEXT NOT NULL CHECK(transport IN ('stdio','sse','streamable_http')),
     endpoint TEXT NOT NULL,
     secret_ref TEXT,
     config_json TEXT DEFAULT '{}',
     enabled INTEGER NOT NULL DEFAULT 1,
     created_by TEXT NOT NULL,
     created_at TEXT NOT NULL DEFAULT (datetime('now'))
   );
   ```

3. **Protocol 升级**
   - Event envelope 增加 `execution_id` + `session_id` 字段
   - 新增事件类型：`text_delta`、`heartbeat`、`confirmation_request`、`confirmation_decision`
   - Python 生成脚本统一到 `schemas/v2`

4. **新增权限 keys**
   - `session:read`、`session:write`
   - `execution:read`、`execution:create`
   - `git:read`、`git:write`
   - `skill:read`、`skill:write`
   - `mcp:read`、`mcp:write`

**关键文件**：
- `server/hub-server-go/` — Go Hub 全新项目
- `server/hub-server-go/migrations/0001_init.sql` — 全量建表
- `server/hub-server-go/sqlc.yaml` + `internal/db/queries/` — sqlc 配置与生成
- `packages/protocol/schemas/v2/` — event schema 升级
- `packages/protocol/scripts/generate-python.sh` — 修复 v1 → v2
- `packages/protocol/scripts/generate-go.sh`（新）— Go 类型生成

**验收标准**：
- Go Hub 可编译并启动
- DB migration 执行成功（SQLite + Postgres）
- `go test ./...` 通过
- Protocol 生成脚本输出 v2 类型（TS + Python + Go）

**复杂度**：L（因为 Hub 全部重写，骨架 + 数据模型一起做）

---

### Phase 1: Hub Session Authority — Hub 成为 Session 权威

**目标**：Session CRUD 从 runtime 迁移到 Hub；Desktop 对 Hub 发 session 请求。

**构建内容**：

1. **Hub Sessions 路由**
   ```
   GET    /v1/sessions?workspace_id=...&project_id=...
   POST   /v1/sessions?workspace_id=...
   PATCH  /v1/sessions/{session_id}?workspace_id=...
   DELETE /v1/sessions/{session_id}?workspace_id=...  (归档，非物理删除)
   ```

2. **Hub SessionService**
   - `listSessions(workspaceId, projectId)` — 列出项目下的会话
   - `createSession(workspaceId, projectId, { title, mode, modelProfileId, skillSetIds, mcpConnectorIds })` — 创建会话
   - `updateSession(sessionId, { title, mode, ... })` — 更新会话配置
   - `archiveSession(sessionId)` — 归档会话
   - 权限校验：`session:read` / `session:write`

3. **Desktop DataSource 改造**
   - 移除 `runtimeClient` 中的 session CRUD
   - `dataSource.ts`：session 操作统一调用 `hubClient.sessions.*`
   - Local 模式：hubClient.baseUrl = local hub endpoint
   - Remote 模式：hubClient.baseUrl = remote hub endpoint
   - **消除 local/remote 分叉**

4. **Sidebar 数据源切换**
   - Session 列表从 hub 获取（不再从 runtime）
   - 支持创建/重命名/归档操作

**关键文件**：
- `server/hub-server-go/internal/handler/sessions.go`（新）
- `server/hub-server-go/internal/service/session.go`（新）
- `server/hub-server-go/internal/db/queries/sessions.sql`（新）
- `apps/desktop-tauri/src/api/dataSource.ts`（重构）
- `apps/desktop-tauri/src/api/hubClient.ts`（扩展 session API）
- `apps/desktop-tauri/src/app/layout/Sidebar.tsx`（数据源切换）

**依赖**：Phase 0

**验收标准**：
- Desktop 通过 Go Hub 创建/列出/重命名/切换 session
- Local 和 Remote 模式使用相同代码路径
- Session 数据持久化在 Hub DB
- `go test ./...` 通过

**复杂度**：L

---

### Phase 2: Execution Flow — 执行流重写（核心，最大工作量）

**目标**：实现完整的 Hub 主控执行流：session execute → hub 调度 → worker 执行 → 事件流转 → 完成清理。

**构建内容**：

#### 2.1 Hub 执行调度

```
POST /v1/sessions/{session_id}/execute?workspace_id=...
Body: { "message": "用户指令" }

流程：
1. RBAC 校验 execution:create
2. BEGIN IMMEDIATE 事务
3. SELECT active_execution_id FROM sessions WHERE session_id = ? FOR UPDATE
4. 若 active_execution_id IS NOT NULL → 409 SESSION_BUSY
5. 创建 execution 记录（state=pending, trace_id=生成）
6. UPDATE sessions SET active_execution_id = ?, status = 'executing'
7. COMMIT
8. 计算 execution context（repo_root, worktree 策略, policy）
9. 异步调度到 worker: POST <worker_base_url>/internal/executions
10. 返回 { execution_id, trace_id }
```

```
409 SESSION_BUSY 响应：
{
  "error": {
    "code": "E_SESSION_BUSY",
    "message": "Session has an active execution",
    "trace_id": "...",
    "retryable": false,
    "meta": {
      "active_execution_id": "...",
      "active_execution_state": "executing"
    }
  }
}
```

#### 2.2 Hub 事件流 SSE

```
GET /v1/sessions/{session_id}/events?workspace_id=...&since_seq=0

SSE stream:
- 推送当前 active execution 的事件
- 支持 since_seq 断点续传
- 设置 event id = seq（用于 Last-Event-ID）
- heartbeat: 每 15s 发送 `:keepalive\n\n`
```

#### 2.3 Hub 内部 API（接收 Worker 事件上报）

```
POST /internal/executions/{execution_id}/events
X-Hub-Auth: <shared_secret>
Body: {
  "events": [
    { "seq": N, "ts": "...", "type": "plan|tool_call|...", "payload": {...} }
  ]
}

Hub 处理：
1. 验证 X-Hub-Auth
2. 批量写入 execution_events 表
3. 更新 executions.last_event_ts
4. 推送到 SSE 客户端
5. 若 type='done' → 清理 session mutex + 更新 execution state
6. 若 type='confirmation_request' → 创建 tool_confirmations 记录 + 更新 session status
```

#### 2.4 Hub Confirmation 路由（增强）

```
POST /v1/confirmations?workspace_id=...
Body: { "execution_id": "...", "call_id": "...", "decision": "approved|denied" }

流程：
1. RBAC 校验 confirm:write
2. 更新 tool_confirmations 状态
3. 转发到 worker: POST <worker>/internal/confirmations
4. 写 audit_log
```

#### 2.5 Worker 重构

```python
# 原 RunService → ExecutionService
class ExecutionService:
    """受控 Worker：接收 Hub 调度，执行 agent，上报事件到 Hub"""

    async def execute(self, execution_context: ExecutionContext):
        """
        execution_context 来自 Hub 调度，包含：
        - execution_id, session_id, project_id
        - user_message
        - mode (plan/agent)
        - model_profile (provider/model/params)
        - skill_set_ids, mcp_connector_ids
        - repo_root, worktree_root, use_worktree
        - user_info (git_name, git_email)
        """
        # 1. 创建 worktree（如需要）
        # 2. 初始化 agent（按 mode + model + skills/mcp）
        # 3. 执行 agent loop
        # 4. 产出事件 → batch POST 到 Hub
        # 5. 等待 confirmation → 从 Hub 回调获取决策
        # 6. 完成 → 发送 done event → Hub 清理 mutex

    async def _report_events(self, execution_id: str, events: list):
        """批量上报事件到 Hub"""
        await self.hub_client.post(
            f"/internal/executions/{execution_id}/events",
            json={"events": events}
        )
```

Worker 内部 API：
```
POST /internal/executions          — 接收 Hub 调度
POST /internal/confirmations       — 接收 confirmation 决策
GET  /internal/health              — 健康检查
```

#### 2.6 Desktop 改造

```typescript
// ConversationPage 核心流程变更
// 旧: createRun(sessionId, message) → runId → SSE /runs/{runId}/events
// 新: executeSession(sessionId, message) → executionId → SSE /sessions/{sessionId}/events

// executionStore.ts (原 runStore.ts)
interface ExecutionState {
  executionId: string | null;
  sessionId: string;
  status: 'idle' | 'executing' | 'waiting_confirmation' | 'completed' | 'failed';
  events: ExecutionEvent[];
  pendingConfirmations: Confirmation[];
  lastPatch: PatchInfo | null;
}

// 会话 busy 处理
async function handleSessionBusy(error: SessionBusyError) {
  const choice = await showBusyDialog({
    activeExecutionId: error.meta.active_execution_id,
    options: ['cancel_current', 'new_session']
  });
  if (choice === 'cancel_current') {
    await hubClient.cancelExecution(error.meta.active_execution_id);
    // 重试 execute
  } else {
    // 创建新 session 并执行
  }
}
```

**关键文件**：
- `server/hub-server-go/internal/handler/executions.go`（新）
- `server/hub-server-go/internal/handler/internal_events.go`（新）
- `server/hub-server-go/internal/service/execution_scheduler.go`（新）
- `server/hub-server-go/internal/service/sse_manager.go`（新）
- `runtime/python-agent/app/services/run_service.py` → `execution_service.py`（重构）
- `runtime/python-agent/app/api/runs.py` → `internal_executions.py`（重构）
- `runtime/python-agent/app/services/hub_reporter.py`（新）
- `apps/desktop-tauri/src/pages/ConversationPage.tsx`（重写）
- `apps/desktop-tauri/src/stores/runStore.ts` → `executionStore.ts`（重写）
- `apps/desktop-tauri/src/api/dataSource.ts`（执行部分重写）
- `apps/desktop-tauri/src/hooks/useRunEvents.ts` → `useExecutionEvents.ts`（重写）

**依赖**：Phase 0, Phase 1

**验收标准**：
- Desktop 创建 session → 发送指令 → Hub 调度 → Worker 执行 → 事件回到 UI
- Session mutex 生效：同 session 第二条指令返回 409
- SSE 断线重连正常工作
- Cancel execution 正常工作
- `pnpm test` 全仓通过

**复杂度**：XL

---

### Phase 3: Worktree + Git Commit — 执行隔离与版本控制

**目标**：每次执行在独立 worktree 中进行，支持 Git 本地 commit。

**构建内容**：

#### 3.1 Worker Worktree 管理

```python
class WorktreeManager:
    """管理 execution 级别的 git worktree"""

    WORKTREE_BASE = ".goyais/worktrees"

    async def create_worktree(self, repo_root: str, execution_id: str) -> str:
        """
        创建执行专属 worktree
        worktree_root = <repo_root>/.goyais/worktrees/<execution_id>
        branch = goyais-exec-<execution_id>
        """
        worktree_root = os.path.join(repo_root, self.WORKTREE_BASE, execution_id)
        branch_name = f"goyais-exec-{execution_id}"
        await run_command(
            f"git worktree add {worktree_root} -b {branch_name}",
            cwd=repo_root
        )
        return worktree_root

    async def cleanup_worktree(self, repo_root: str, execution_id: str):
        """清理 worktree（成功时默认清理，失败时保留）"""
        worktree_root = os.path.join(repo_root, self.WORKTREE_BASE, execution_id)
        await run_command(f"git worktree remove {worktree_root} --force", cwd=repo_root)
        # 删除临时分支
        branch_name = f"goyais-exec-{execution_id}"
        await run_command(f"git branch -D {branch_name}", cwd=repo_root)
```

#### 3.2 Path Guard 增强

```python
# 所有 tool 操作限定在 worktree_root 内
def validate_path(path: str, worktree_root: str) -> str:
    resolved = os.path.realpath(os.path.join(worktree_root, path))
    if not resolved.startswith(os.path.realpath(worktree_root)):
        raise PathEscapeError(f"Path {path} escapes worktree root")
    return resolved
```

#### 3.3 Git Commit

```
Hub API:
POST /v1/executions/{execution_id}/commit?workspace_id=...
Body: { "message": "commit message (optional)" }

流程：
1. RBAC: git:write
2. 获取 user profile (git_name, git_email)
3. POST <worker>/internal/executions/{id}/commit
   Body: { "message": "...", "git_name": "...", "git_email": "..." }
4. Worker 在 worktree 内：
   - 设置 GIT_AUTHOR_NAME/EMAIL + GIT_COMMITTER_NAME/EMAIL
   - git add -A && git commit -m "..."
   - 返回 commit_sha
5. Hub 记录 audit_log (action=git.commit, commit_sha)
6. 返回 { commit_sha }
```

```
Hub API:
GET /v1/executions/{execution_id}/patch?workspace_id=...

流程：
1. RBAC: execution:read
2. 从 execution_events 中聚合所有 type='patch' 的 payload
3. 返回 unified diff 文本
```

#### 3.4 Desktop UI

- Execution 完成后在对话流底部显示操作栏：
  - **[Commit]** — 打开 commit message 输入框 → 调用 commit API → 显示 SHA
  - **[Export Patch]** — 调用 patch API → 下载 .patch 文件
  - **[Discard]** — 确认后清理 worktree 变更

**关键文件**：
- `runtime/python-agent/app/services/worktree_manager.py`（新）
- `runtime/python-agent/app/tools/git_tools.py`（重构）
- `runtime/python-agent/app/tools/policy.py`（path guard 增强）
- `server/hub-server/src/routes/executions.ts`（扩展 commit/patch）
- `apps/desktop-tauri/src/components/domain/conversation/ExecutionActions.tsx`（新）

**依赖**：Phase 2

**验收标准**：
- 执行在独立 worktree 中进行，主分支不受影响
- Git commit author/committer = 当前登录用户
- Patch 导出为有效的 unified diff
- 成功执行后 worktree 自动清理
- 失败执行 worktree 保留

**复杂度**：L

---

### Phase 4: Session Config + Agent Mode — 会话配置与模式增强

**目标**：会话级配置 UI + plan/agent 两种模式的完善。

**构建内容**：

#### 4.1 Session 创建对话框

```
CreateSessionDialog:
├── Title: 文本输入（自动生成建议）
├── Mode: plan | agent（radio）
│   ├── plan: "先给计划，确认后执行"
│   └── agent: "自主执行，敏感操作确认"
├── Model: 下拉选择（从 model_configs 获取）
├── Worktree: 开关（默认开启）
├── Skills: 多选（从 skill_sets 获取）
└── MCP Connectors: 多选（从 mcp_connectors 获取）
```

#### 4.2 Worker Plan 模式状态机

```
plan 模式流程：
1. Agent 分析用户指令
2. 产出 plan event（包含步骤列表）
3. 标记 requires_confirmation: true
4. 等待 Hub 回传 plan 确认
5. 确认后：执行 plan 中的 tools → patch → done
6. 拒绝后：error event → done

agent 模式流程：
1. Agent 自主执行 tool loop
2. 敏感操作（write_fs/exec/network/delete）→ 确认
3. 非敏感操作 → 直接执行
4. patch → done
```

#### 4.3 Capability Prompt 增强

```python
# 风险等级与能力分类
CAPABILITY_CATEGORIES = {
    'write_fs': {'risk': 'high', 'requires_confirmation': True},
    'exec': {'risk': 'high', 'requires_confirmation': True},
    'network': {'risk': 'high', 'requires_confirmation': True},
    'delete': {'risk': 'critical', 'requires_confirmation': True},
    'exfil': {'risk': 'critical', 'requires_confirmation': True},
    'read_fs': {'risk': 'low', 'requires_confirmation': False},
    'search': {'risk': 'low', 'requires_confirmation': False},
}

# Always Allow Scope（可配置白名单）
class AlwaysAllowScope:
    workspace_id: str
    tool_name: str
    risk_level: str
    # 当用户在 confirmation 中勾选 "Always allow" 时记录
    # 后续同 workspace + tool + risk 自动放行
```

**关键文件**：
- `apps/desktop-tauri/src/components/domain/session/CreateSessionDialog.tsx`（新）
- `apps/desktop-tauri/src/components/domain/session/SessionConfigPanel.tsx`（新）
- `runtime/python-agent/app/agent/graph_agent.py`（plan 模式增强）
- `runtime/python-agent/app/agent/state_machine.py`（新，plan/agent 状态机）
- `runtime/python-agent/app/tools/policy.py`（capability 分类）

**依赖**：Phase 2

**验收标准**：
- 创建会话时可选择 mode/model/worktree/skills/mcp
- Plan 模式：先展示计划 → 用户确认 → 再执行
- Agent 模式：自主执行，敏感操作触发确认
- Always Allow 正确记录和生效

**复杂度**：M

---

### Phase 5: Remote Git Projects — 远程 Git 仓库项目

**目标**：Remote workspace 支持 Git repo URL 项目，含 clone/sync。

**构建内容**：

#### 5.1 Hub Projects 表扩展

```sql
-- 0006_projects_git_enhancement.sql
ALTER TABLE projects ADD COLUMN repo_url TEXT;
ALTER TABLE projects ADD COLUMN branch TEXT DEFAULT 'main';
ALTER TABLE projects ADD COLUMN auth_ref TEXT;       -- secret_ref 指向 secrets 表
ALTER TABLE projects ADD COLUMN repo_cache_path TEXT;
ALTER TABLE projects ADD COLUMN sync_status TEXT DEFAULT 'pending'
  CHECK(sync_status IN ('pending','syncing','ready','error'));
ALTER TABLE projects ADD COLUMN sync_error TEXT;
ALTER TABLE projects ADD COLUMN last_synced_at TEXT;
```

#### 5.2 Hub ProjectSyncService

```typescript
class ProjectSyncService {
  async syncProject(projectId: string, workspaceId: string): Promise<void> {
    // 1. 获取 project 定义
    // 2. 更新 sync_status = 'syncing'
    // 3. 解析 auth（如有 auth_ref → resolve secret）
    // 4. 若 repo_cache_path 不存在 → git clone
    // 5. 若已存在 → git fetch + git checkout branch + git pull
    // 6. 成功 → sync_status = 'ready'
    // 7. 失败 → sync_status = 'error', sync_error = message
  }
}
```

#### 5.3 API

```
POST /v1/projects?workspace_id=...
Body: { "name": "...", "repo_url": "...", "branch": "main", "auth_ref": "..." }

POST /v1/projects/{project_id}/sync?workspace_id=...
// 触发同步

GET /v1/projects?workspace_id=...
// 返回含 sync_status 的项目列表
```

#### 5.4 Desktop UI

- Project 列表显示 sync_status（syncing 动画、ready 绿点、error 红点）
- 项目右键菜单：Sync Now
- 添加项目对话框：支持 Git URL + branch + 凭证选择

**关键文件**：
- `server/hub-server/migrations/0006_projects_git_enhancement.sql`（新）
- `server/hub-server/src/routes/projects.ts`（扩展）
- `server/hub-server/src/services/projectSyncService.ts`（新）
- `apps/desktop-tauri/src/app/layout/Sidebar.tsx`（项目状态展示）
- `apps/desktop-tauri/src/components/domain/project/AddProjectDialog.tsx`（增强）

**依赖**：Phase 0（可与 Phase 1-2 并行开发）

**验收标准**：
- 通过 Git URL 添加 remote 项目
- 服务端 clone 完成后 sync_status = ready
- clone 失败显示错误信息
- Sync Now 触发重新同步

**复杂度**：M

---

### Phase 6: Skills/MCP — 技能与 MCP 连接器

**目标**：Workspace 级 Skills 和 MCP Connector 管理，会话级绑定和 Worker 注入。

**构建内容**：

#### 6.1 Hub API

```
-- Skill Sets --
GET    /v1/skill-sets?workspace_id=...
POST   /v1/skill-sets?workspace_id=...
PUT    /v1/skill-sets/{id}?workspace_id=...
DELETE /v1/skill-sets/{id}?workspace_id=...

GET    /v1/skill-sets/{id}/skills?workspace_id=...
POST   /v1/skill-sets/{id}/skills?workspace_id=...
DELETE /v1/skills/{id}?workspace_id=...

-- MCP Connectors --
GET    /v1/mcp-connectors?workspace_id=...
POST   /v1/mcp-connectors?workspace_id=...
PUT    /v1/mcp-connectors/{id}?workspace_id=...
DELETE /v1/mcp-connectors/{id}?workspace_id=...
POST   /v1/mcp-connectors/{id}/test?workspace_id=...  (可选：连接测试)
```

权限：`skill:read`/`skill:write`、`mcp:read`/`mcp:write`

#### 6.2 Worker Skills/MCP 注入

```python
class ToolInjector:
    """从 execution context 注入 skills 和 MCP tools 到 agent"""

    async def inject(self, agent: BaseAgent, context: ExecutionContext):
        # 1. 加载 skill_sets → 解析为 tool 组合
        for skill_set_id in context.skill_set_ids:
            skills = await self.hub_client.get_skills(skill_set_id)
            for skill in skills:
                agent.register_tool(self._skill_to_tool(skill))

        # 2. 加载 MCP connectors → 建立连接 → 注入 tools
        for connector_id in context.mcp_connector_ids:
            connector = await self.hub_client.get_connector(connector_id)
            mcp_client = await self._connect_mcp(connector)
            tools = await mcp_client.list_tools()
            for tool in tools:
                agent.register_tool(self._mcp_tool_wrapper(tool, mcp_client))
```

#### 6.3 Desktop UI

- **Settings → Skills 面板**：列表展示 skill sets + CRUD
- **Settings → MCP 面板**：列表展示 connectors + CRUD + 连接测试
- **Session 创建对话框**：skills 和 MCP 多选器（已在 Phase 4 预留）

**关键文件**：
- `server/hub-server/src/routes/skills.ts`（新）
- `server/hub-server/src/routes/mcp-connectors.ts`（新）
- `server/hub-server/src/services/skillService.ts`（新）
- `server/hub-server/src/services/mcpService.ts`（新）
- `runtime/python-agent/app/services/tool_injector.py`（新）
- `runtime/python-agent/app/tools/mcp_wrapper.py`（新）
- `apps/desktop-tauri/src/components/settings/SkillsPanel.tsx`（新）
- `apps/desktop-tauri/src/components/settings/McpPanel.tsx`（新）
- `apps/desktop-tauri/src/pages/SettingsPage.tsx`（扩展 skills/mcp tab）

**依赖**：Phase 0, Phase 2, Phase 4

**验收标准**：
- Workspace 管理员可 CRUD skills 和 MCP connectors
- 创建会话时可选择 skills/MCP
- Worker 正确加载并使用 skills/MCP tools
- MCP connector 连接测试可用

**复杂度**：L

---

### Phase 7: Polish + Observability — 收尾与可观测性

**目标**：生产就绪：可观测性、稳定性、安全审计、测试覆盖。

**构建内容**：

1. **SSE 断线重连**
   - 客户端：自动重连 + `Last-Event-ID` 续传
   - Hub：`?since_seq=N` 支持 + 内存 ring buffer (500条)

2. **Execution Timeout Watchdog**
   - Hub 后台任务：每 30s 扫描超时 execution
   - 默认 timeout: 120s 无事件上报
   - 自动标记 failed + 清理 session mutex

3. **trace_id 贯穿**
   - Hub 为每次 execution 生成 trace_id
   - 传递到 Worker → 写入所有事件和日志
   - Desktop 显示 trace_id（可复制）

4. **审计完善**
   - 覆盖：tool_call、confirmation、git.commit、project sync、session CRUD
   - 审计日志查询 API（管理员）

5. **诊断导出脱敏**
   - 导出内容：execution events + audit logs + 关键错误
   - 脱敏：token/api_key/secret 明文替换为 `[REDACTED]`
   - 可选：脱敏本地路径

6. **Workspace 配额**
   - workspace 最大并发执行数
   - project 最大并发执行数
   - user 最大并发执行数
   - 超限返回 429

7. **E2E 测试**
   - 本地模式：创建 session → execute → events → commit → patch
   - Remote 模式：login → workspace → project → session → execute
   - Session mutex 测试
   - Worktree 创建/清理测试

8. **i18n 完善**
   - 新增所有 v0.2.0 相关 keys（session busy / execution 状态 / worktree / capability prompt 等）
   - zh-CN / en-US 双语对齐

**关键文件**：
- `server/hub-server/src/services/watchdog.ts`（新）
- `server/hub-server/src/services/sseManager.ts`（增强）
- `apps/desktop-tauri/src/hooks/useExecutionEvents.ts`（断线重连）
- `apps/desktop-tauri/src/i18n/locales/en-US/common.json`（扩展）
- `apps/desktop-tauri/src/i18n/locales/zh-CN/common.json`（扩展）
- 全仓测试文件

**依赖**：Phase 2-6

**验收标准**：
- SSE 断线后自动重连，事件不丢失
- Worker 崩溃后 session 自动恢复（不再 busy）
- 诊断导出不含敏感信息
- `pnpm test && pnpm typecheck && pnpm lint` 全绿
- E2E 场景全部通过

**复杂度**：M

---

## 5. 实施路径与时间线

> 注意：Hub 从 TypeScript 重写为 Go，Phase 0 包含 Go 项目骨架搭建 + 基础 Auth/RBAC 移植。
> 旧 TS Hub (`server/hub-server/`) 代码作为参考实现保留，功能逻辑一一对应移植到 Go。

```
Week 1-2:   Phase 0  Go Hub 骨架 + Auth/RBAC/基础路由 + 数据模型 + 协议
            Phase 5  Remote Git Projects（可并行）

Week 3-4:   Phase 1  Hub Session Authority（Go 实现）

Week 4-7:   Phase 2  Execution Flow（核心，最大工作量）

Week 7-8:   Phase 3  Worktree + Git Commit     ┐
            Phase 4  Session Config + Agent Mode ├── 可并行
            Phase 6  Skills/MCP                  ┘

Week 9:     Phase 7  Polish + Observability

Week 10:    Buffer + 集成测试 + Bug Fix
```

**总计**：~10-11 周（单人全职），~6-7 周（2-3 人并行）

> Go Hub 重写相比 TS 增加约 1-2 周，但长期收益（单二进制部署、goroutine 并发、零运行时依赖）远超前期投入。

---

## 6. 需要新增的关键文件清单

### Hub Server — Go 重写（`server/hub-server-go/`）
| 文件 | 说明 | Phase |
|------|------|-------|
| `cmd/hub/main.go` | Go Hub 入口 | 0 |
| `internal/config/config.go` | 环境变量配置 | 0 |
| `internal/db/db.go` | DB 接口 + dialect 选择 | 0 |
| `internal/db/sqlite.go` | SQLite 连接（go-sqlite3） | 0 |
| `internal/db/postgres.go` | Postgres 连接（pgx） | 0 |
| `migrations/0001_init.sql` | 全量建表（含 v0.2.0 所有表） | 0 |
| `internal/handler/auth.go` | Auth/Bootstrap API | 0 |
| `internal/handler/sessions.go` | Session CRUD API | 1 |
| `internal/handler/executions.go` | Execute + Commit + Patch API | 2 |
| `internal/handler/internal_events.go` | Worker 事件上报 internal API | 2 |
| `internal/handler/skills.go` | Skill Sets CRUD API | 6 |
| `internal/handler/mcp_connectors.go` | MCP Connectors CRUD API | 6 |
| `internal/service/session.go` | Session 业务逻辑 | 1 |
| `internal/service/execution_scheduler.go` | 执行调度 + session mutex | 2 |
| `internal/service/sse_manager.go` | SSE 事件推送（goroutine per conn） | 2 |
| `internal/service/project_sync.go` | Git 项目 clone/sync | 5 |
| `internal/service/skill.go` | Skills 业务逻辑 | 6 |
| `internal/service/mcp.go` | MCP 业务逻辑 | 6 |
| `internal/service/watchdog.go` | Execution 超时监控 | 7 |
| `internal/middleware/auth.go` | Token 认证中间件 | 0 |
| `internal/middleware/rbac.go` | RBAC 权限中间件 | 0 |
| `internal/middleware/trace.go` | Trace ID 中间件 | 0 |
| `sqlc.yaml` | sqlc 配置 | 0 |
| `Makefile` | build/test/migrate/generate 命令 | 0 |

### Runtime/Worker（`runtime/python-agent/`）
| 文件 | 说明 | Phase |
|------|------|-------|
| `app/services/execution_service.py` | 重构自 run_service.py | 2 |
| `app/services/hub_reporter.py` | 事件上报到 Hub | 2 |
| `app/services/worktree_manager.py` | Worktree 生命周期管理 | 3 |
| `app/api/internal_executions.py` | 内部 execution/confirmation API | 2 |
| `app/agent/state_machine.py` | Plan/Agent 模式状态机 | 4 |
| `app/services/tool_injector.py` | Skills/MCP 注入 | 6 |
| `app/tools/mcp_wrapper.py` | MCP tool 封装 | 6 |

### Desktop（`apps/desktop-tauri/`）
| 文件 | 说明 | Phase |
|------|------|-------|
| `src/stores/executionStore.ts` | 重构自 runStore.ts | 2 |
| `src/hooks/useExecutionEvents.ts` | 重构自 useRunEvents.ts | 2 |
| `src/components/domain/session/CreateSessionDialog.tsx` | 会话创建对话框 | 4 |
| `src/components/domain/session/SessionConfigPanel.tsx` | 会话配置面板 | 4 |
| `src/components/domain/conversation/ExecutionActions.tsx` | Commit/Patch/Discard | 3 |
| `src/components/settings/SkillsPanel.tsx` | Skills 管理 | 6 |
| `src/components/settings/McpPanel.tsx` | MCP 管理 | 6 |

### 需要重构/新增的关键文件
| 文件 | 变更说明 | Phase |
|------|---------|-------|
| `server/hub-server/` | **归档（不删除）**，Go Hub 完全替代 | 0 |
| `server/hub-server-go/` | **全新 Go Hub 项目** | 0-7 |
| `runtime/python-agent/app/services/run_service.py` | → execution_service.py | 2 |
| `runtime/python-agent/app/api/runs.py` | → internal_executions.py | 2 |
| `runtime/python-agent/app/tools/git_tools.py` | Worktree 管理 + commit | 3 |
| `runtime/python-agent/app/tools/policy.py` | Path guard + capability 分类 | 3+4 |
| `runtime/python-agent/app/agent/graph_agent.py` | Plan 模式增强 | 4 |
| `apps/desktop-tauri/src/pages/ConversationPage.tsx` | 执行流全面重写 | 2 |
| `apps/desktop-tauri/src/api/dataSource.ts` | 统一 hub-first | 1+2 |
| `apps/desktop-tauri/src/api/hubClient.ts` | 扩展 session/execution/skills API | 1+2+6 |
| `apps/desktop-tauri/src/app/layout/Sidebar.tsx` | 数据源切换 + 项目状态 | 1+5 |
| `apps/desktop-tauri/src/pages/SettingsPage.tsx` | Skills/MCP tab | 6 |

---

## 7. 验证计划

### 7.1 每 Phase 验收

| Phase | 验收方式 | 状态 |
|-------|---------|------|
| 0 | Hub 启动 → 新表存在 → `pnpm test` 通过 | ✅ DONE |
| 1 | Desktop 通过 Hub 创建/列出/切换 session（local + remote 同路径） | ✅ DONE |
| 2 | 完整执行流：Desktop → Hub → Worker → Events → UI；session busy 409 | ✅ DONE |
| 3 | Worktree 隔离执行 + git commit author 正确 + patch 导出有效 | ✅ DONE |
| 4 | Plan 模式确认流 + agent 模式敏感操作确认 + 会话配置 UI | ✅ DONE |
| 5 | Git URL 添加项目 → clone → ready → 可创建 session | ✅ DONE |
| 6 | Skills/MCP CRUD + 会话绑定 + Worker 正确加载使用 | ✅ DONE |
| 7 | SSE 重连 + watchdog + 审计 + 诊断 + E2E 全绿 | ✅ DONE |

### 7.2 最终验收

```bash
# 质量闸门
pnpm test && pnpm typecheck && pnpm lint

# 功能验收（本地）
# 1. 启动 Desktop → local hub + local worker 自动启动
# 2. 添加本地项目 → 创建 session（plan 模式）→ 发送指令
# 3. 查看 plan → 确认 → 执行 → diff 展示 → commit → 导出 patch
# 4. 同 session 再发指令 → worktree 隔离验证
# 5. 会话执行中再发 → 409 busy → cancel / new session

# 功能验收（团队）
# 1. 连接 remote hub → 登录 → 选择 workspace
# 2. 添加 Git URL 项目 → 同步 ready
# 3. 创建 session（agent 模式 + skills + MCP）→ 执行
# 4. 敏感操作确认 → commit → 审计可查
# 5. 多 session 并行开发 → worktree 隔离有效
```
