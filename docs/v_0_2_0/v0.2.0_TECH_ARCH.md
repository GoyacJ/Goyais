# Goyais 技术架构文档 v0.2.0
角色：首席架构师 + Agent 工程负责人
目标：为 PRD v0.2.0 提供可落地、可扩展、可部署的技术架构设计。
原则：**对外只暴露“会话（Session）”体验**，内部可用执行记录/事件流承载执行细节；会话同一时间仅允许一个执行进行中（会话级互斥）。
开源协议：Apache-2.0

---

## 0. 总览（Architecture at a Glance）

### 0.1 系统形态
- **单机模式（Local）**：Desktop App 自带完整能力
  - Desktop Supervisor 启动本地 Hub + 本地 Worker（Python）
  - 项目来自本机 Git repo；执行在本机
- **团队模式（Remote）**：Remote Hub + Server-side Worker Pool
  - Desktop 连接 remote hub（唯一入口）
  - 项目源仅 Git repo（服务端 clone/cache）
  - 执行在服务端 worker；事件流经 hub 推送给客户端
  - 权限与动态菜单由 hub 下发并强制执行

### 0.2 核心边界
- **Control Plane（Hub）**：Auth / RBAC / Menu / Workspace / Project / Session / Model Profiles / Skills / MCP / 调度 / 审计 / 诊断
- **Execution Plane（Worker）**：LLM 编排（LangChain/LangGraph/Deep Agents）、工具执行（fs/patch/command/git/worktree/mcp/skills）、事件产出与审计上报
- **Client（Desktop）**：UI/UX、会话流展示、设置、凭证存储（Keychain）、Supervisor（本地进程管理）

---

## 1. 模块与职责

### 1.1 Desktop（Tauri + React）
职责：
- 会话化 UI：Sidebar 项目/会话树；会话页面呈现思考/工具调用/diff/确认
- 设置：语言/主题/模型/skills/mcp（按权限与数据源）
- 本地凭证：Keychain 存 token/secret refs，不在前端持久化明文
- Local Supervisor：
  - 启动/健康检查/重启本地 Hub 与本地 Worker
  - 端口随机化、退出清理、版本一致性校验（可选）

### 1.2 Hub（本地或远程）
职责（统一）：
- Auth：bootstrap admin、login/logout、token
- RBAC：roles/permissions、role_menus，/me/navigation 下发
- Workspace：workspace list/members
- Project：Git repo project（repo_url/branch/auth_ref/repo_cache_path/status）
- Session：会话 CRUD、会话级配置（mode/model/skills/mcp）
- 执行调度：
  - 会话级互斥（同 session 只有一个 active execution）
  - workspace/project/user 并发上限与队列
  - 分配 worker 执行
- 事件流：
  - 接收 worker 事件并推送给客户端（SSE）
  - 提供历史查询（会话内自然滚动查看；后端可提供分页）
- 安全与审计：
  - capability 决策、confirm 权限校验、审计聚合
- secrets：
  - 加密存储（AES-256-GCM enc:v1）
  - internal resolve 给 worker（一次性）
- 诊断/可观测：health/version/metrics/diagnostics

### 1.3 Worker Pool（Python）
职责：
- Agent 编排：LangChain/LangGraph/Deep Agents
- Tools 执行：
  - read/search
  - write/apply_patch
  - run_command（allowlist/denylist）
  - git/worktree
  - skills / MCP connector 调用
- worktree 管理：
  - 每次执行创建/使用 run-level worktree 目录（建议默认）
- 事件产出：
  - 产出 plan/tool_call/tool_result/patch/error/done
- 确认机制：
  - 对敏感工具标记 requires_confirmation
  - 等待 hub 的 approve/deny 再继续
- Git commit（不 push）：
  - 在 worktree 内 commit
  - author/committer = 当前登录用户（来自 hub 注入或查询）
- 强制内部鉴权：
  - worker 仅接受 hub 内部请求（shared secret / mTLS）
  - 不能被客户端直连

---

## 2. 核心数据模型（系统视角）

> v0.2.0 不在产品层暴露“Run”概念，但系统内部需要“执行记录”来承载事件与审计。本文称为 **Execution**（内部概念），不进入 UI/PRD 术语。

### 2.1 Hub 数据库（建议 Postgres；单机可 SQLite）
- users / auth_tokens / auth_identities（可选 OAuth）
- workspaces / workspace_members
- roles / permissions / role_permissions
- menus / role_menus
- projects（Git repo only）
- sessions（会话）
- model_profiles（provider/model params）
- skill_sets / skills（定义与集合）
- mcp_connectors（连接器配置与 secret refs）
- secrets（enc:v1 AES-GCM）
- executions（内部执行记录：session 的一次执行）
- events（执行事件：强关联 execution_id）
- tool_confirmations（execution_id + call_id，pending/approved/denied）
- audit_logs（聚合审计）

关键字段（示例）：
- sessions：mode、model_profile_id、skill_set_ids、mcp_connector_ids、active_execution_id、status
- executions：execution_id、session_id、project_id、created_by(user_id)、state、trace_id、repo_root、worktree_root、started_at/ended_at
- events：execution_id、seq、ts、type、payload_json
- audit_logs：workspace_id、project_id、session_id、execution_id、user_id、action、tool_name、outcome、created_at

### 2.2 Worker 存储（可选）
- 推荐将事件与审计以 hub 为权威存储（便于共享与查询）
- worker 本地仅保留临时日志/缓存/工作目录
- 若需要离线/性能，可在 worker 持有本地 SQLite 并异步上报（复杂度高，v0.2.0 不建议）

---

## 3. 关键流程（Key Flows）

### 3.1 Remote：添加 Git 项目
1) Client → Hub：POST /projects（repo_url/branch/auth）
2) Hub：保存项目定义，生成 repo_cache_path，执行 clone/sync（或创建 sync job）
3) Hub：project.status=ready 后允许创建 session/执行

安全：
- repo auth 存入 secrets（加密）
- 只允许 project:write 的角色操作

### 3.2 创建会话
1) Client → Hub：POST /sessions（project_id,title,mode,model_profile_id,skill_set_ids,mcp_connector_ids）
2) Hub：写入会话与默认配置

### 3.3 会话内执行（主流体验）
**会话同一时间只允许一个 active execution。**

1) Client 在会话输入框发送指令 → Hub：POST /sessions/{id}/execute
2) Hub：
  - 检查 session.active_execution_id 是否为空
  - 若不为空：返回 409 SESSION_BUSY + 当前状态（用于 UI 提示）
  - 若为空：创建 execution 记录，设置 session.active_execution_id，状态=executing
  - 计算执行上下文（repo_root/worktree_root/policy_context）
  - 调度到 worker
3) Worker：
  - 若 use_worktree：创建 worktree_root（git worktree add）
  - 按 session.mode（plan/agent）执行 LangGraph/Deep Agents 流程
  - 产出事件并上报 hub（流式）
4) Hub：
  - 通过 SSE 将事件推送给客户端
  - 若需要确认：进入 waiting_confirmation 状态
5) Client：
  - UI 展示思考/工具调用/diff/确认
  - confirm 按钮触发 approve/deny
6) Hub → Worker：POST /confirmations（approve/deny）
7) Worker：继续执行直至 done/error
8) Hub：
  - 清理 session.active_execution_id
  - 记录 audit、更新状态、可选清理 worktree（按策略）

### 3.4 Git 本地 commit（服务端 worktree）
触发：执行完成产出 diff 后，用户点击“Commit（本地）”

1) Client → Hub：POST /executions/{id}/commit（message 可选）
2) Hub：
  - RBAC：git:write
  - 获取当前 user 的 git_name/git_email（user profile 或 settings）
  - 调用 worker internal commit
3) Worker：
  - 在 worktree_root 执行：
    - git config user.name/email（repo-local）
    - 设置环境变量 GIT_AUTHOR_*/GIT_COMMITTER_*
    - git add -A && git commit -m ...
  - 返回 commit_sha（不 push）
4) Hub：
  - 记录 audit（git.commit）
  - 返回 commit_sha，UI 展示复制/导出 patch

注意：
- 不允许使用系统共享身份，author/committer 必须是当前登录用户

### 3.5 导出 patch（unified diff）
- Client → Hub：GET /executions/{id}/patch
- Hub 返回统一 diff（从 artifacts 或 events 聚合）

---

## 4. 安全模型

### 4.1 信任边界
- Client 只访问 Hub（公网/内网）
- Worker 不对公网开放，只接受 Hub 内部调用
- Hub 与 Worker 间使用 shared secret 或 mTLS

### 4.2 Secrets
- Hub secrets 加密存储（AES-256-GCM enc:v1）
- Worker 需要外部凭证时：
  - internal resolve（一次性明文）
  - 不落盘，不写日志，不回传客户端
- 日志/诊断导出必须脱敏：token/api_key/secret 明文、可选脱敏本地路径

### 4.3 Capability Prompt 与审计
- 高风险工具必须 requires_confirmation
- Hub enforce confirm:write 权限
- audit_logs 记录：tool_call、decision、git.commit、project sync 等

### 4.4 会话互斥（避免并发冲突）
- Hub 对 session_id 加互斥（DB 层乐观锁或事务锁）
- 任何新 execute 请求若 session busy → 409 返回
- UI 不允许“一个会话多条执行交错展示”

---

## 5. 并发、隔离与 worktree

### 5.1 并发策略
- v0.2.0 的并发单位是 **多会话并行**，同一会话串行执行
- Hub 提供配额：
  - workspace 最大执行数
  - project 最大执行数
  - user 最大执行数

### 5.2 worktree
- 每次执行默认创建独立 worktree（建议默认开启）
- worktree_root = `<repo_root>/.goyais/worktrees/<execution_id>`
- 执行目录 = worktree_root（所有写/命令默认在此）

### 5.3 清理策略
- 成功默认清理（可配置保留 N 次）
- 失败默认保留（便于诊断），管理员可清理

---

## 6. Agent 工程设计（LangChain/LangGraph/Deep Agents）

### 6.1 状态机（建议）
- 输入：用户指令 + session 配置（mode/model/skills/mcp）+ repo context
- 输出：事件流与 artifacts

#### plan 模式
- plan → (等待 plan 确认) → execute tools → patch → (确认 apply/command) → done

#### agent 模式
- read/analyze → patch → (确认 apply/command) → done

### 6.2 Tools 层（强边界）
- 统一 tool registry：每个 tool 标注风险等级与 requires_confirmation
- Path guard：限定 repo_root/worktree_root 内
- Command guard：denylist/allowlist + 超时
- 网络工具：默认禁用或强确认，域名白名单（用于 git sync/mcp）

### 6.3 Skills/MCP 注入
- skills：受控工具组合 + 模板
- mcp connectors：由 hub 下发配置与权限，worker 按 policy 调用

---

## 7. API 规范（对外 Hub API）

> 仅列出关键路径，具体字段按 JSON Schema/TS 类型定义。

### 7.1 Auth / Me / Navigation
- GET /v1/auth/bootstrap/status
- POST /v1/auth/bootstrap/admin
- POST /v1/auth/login
- POST /v1/auth/logout
- GET /v1/me
- GET /v1/me/navigation?workspace_id=...

### 7.2 Workspaces / Projects / Sessions
- GET /v1/workspaces
- POST /v1/projects?workspace_id=...
- POST /v1/projects/{project_id}/sync?workspace_id=...
- GET /v1/sessions?workspace_id=...&project_id=...
- POST /v1/sessions?workspace_id=...
- PATCH /v1/sessions/{session_id}?workspace_id=...

### 7.3 会话执行与事件流
- POST /v1/sessions/{session_id}/execute?workspace_id=...
- GET /v1/sessions/{session_id}/events?workspace_id=...  （SSE，推送当前执行）
- POST /v1/confirmations?workspace_id=...                （approve/deny）

### 7.4 commit / patch / diagnostics
- POST /v1/executions/{execution_id}/commit?workspace_id=...
- GET /v1/executions/{execution_id}/patch?workspace_id=...
- GET /v1/diagnostics?workspace_id=...
- GET /v1/health
- GET /v1/version
- GET /v1/metrics（可选）

---

## 8. Desktop 技术要点

### 8.1 数据源策略（hub-first）
- Local workspace：base_url = local hub
- Remote workspace：base_url = remote hub
- Desktop 永远只对 hub 发请求（不直连 worker）

### 8.2 状态管理
- workspaceStore：当前 workspace、endpoint、权限与菜单缓存（按 workspace 分桶）
- projectStore / sessionStore：项目/会话列表
- sessionExecutionStore：当前会话执行状态（executing/waiting_confirmation）
- permissionQueueStore：确认队列（按会话/执行）

### 8.3 UI 行为规范
- 会话 busy 时输入：弹出 busy 提示（cancel/new session/queue）
- 事件流折叠规则：长日志默认折叠；diff 优先
- 诊断复制：强制脱敏

---

## 9. 部署拓扑

### 9.1 单机（Local）
- Desktop app
  - local hub（localhost，随机端口）
  - local worker（localhost，随机端口）
- repo 在本地文件系统
- secrets 在本地 keychain 或 local hub 加密存储

### 9.2 团队（Remote）
- remote hub + DB（Postgres 推荐）
- worker pool（容器/进程，最小 1 个）
- repo cache 挂载到 worker（共享卷或每 worker 本地 clone）
- 建议 docker-compose 一键部署

---

## 10. 可观测性与诊断

- trace_id：Hub 为每次会话执行生成并贯穿 worker
- logs：结构化字段固定（trace_id/workspace_id/user_id/project_id/session_id/execution_id）
- metrics：
  - hub：请求、SSE 连接、RBAC 拒绝、调度延迟
  - worker：工具调用次数、确认等待时长、失败率
- diagnostics：
  - 会话执行诊断包导出（事件+审计+关键错误，脱敏）

---

## 11. 关键架构决策（ADR 摘要）
1) 产品只暴露会话概念；会话同一时间只允许一个执行（避免主流体验冲突）
2) remote 必须 hub 权威 + server-side worker pool（执行不在客户端）
3) remote 项目源 v0.2.0 仅支持 Git repo
4) worktree 作为每次执行隔离目录（并行通过多会话实现）
5) git commit 必须绑定当前登录用户（author/committer），仅本地 commit 不 push
6) secrets 只在 hub 加密存储，worker internal resolve 一次性使用

---
